# ğŸ“± Há»‡ Thá»‘ng ThÃ´ng BÃ¡o - ZaloClone

**Version:** 1.0  
**Last Updated:** 2025-12-27  
**Author:** Development Team

---

## ğŸ“‹ Má»¥c Lá»¥c

1. [Tá»•ng Quan](#tá»•ng-quan)
2. [Kiáº¿n TrÃºc Há»‡ Thá»‘ng](#kiáº¿n-trÃºc-há»‡-thá»‘ng)
3. [Incoming Call Notifications](#incoming-call-notifications)
4. [Chat Message Notifications](#chat-message-notifications)
5. [Permissions Required](#permissions-required)
6. [Cáº¥u HÃ¬nh](#cáº¥u-hÃ¬nh)
7. [Testing Guide](#testing-guide)
8. [Troubleshooting](#troubleshooting)
9. [Known Issues](#known-issues)

---

## Tá»•ng Quan

Há»‡ thá»‘ng notification cá»§a ZaloClone cung cáº¥p 3 loáº¡i thÃ´ng bÃ¡o chÃ­nh:

### 1. **Incoming Call Notifications** (Cuá»™c Gá»i Äáº¿n)
- âœ… Full-screen pop-up khi app background/killed
- âœ… Ringtone + Vibration
- âœ… Auto-launch CallActivity
- âœ… Wake screen from sleep

### 2. **Chat Message Notifications** (Tin Nháº¯n)
- âœ… Banner notification vá»›i tÃªn ngÆ°á»i gá»­i
- âœ… Rich content preview (image, voice, file, sticker)
- âœ… Filter out call-related messages

### 3. **Friend Request Notifications** (Lá»i Má»i Káº¿t Báº¡n)
- âœ… Notification khi nháº­n lá»i má»i káº¿t báº¡n
- âœ… Action buttons: Accept/Decline

---

## Kiáº¿n TrÃºc Há»‡ Thá»‘ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     USER DEVICE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ MainActivity â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚PermissionMgr â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                      â”‚                            â”‚
â”‚         â”‚                      â”œâ”€ POST_NOTIFICATIONS        â”‚
â”‚         â”‚                      â”œâ”€ USE_FULL_SCREEN_INTENT    â”‚
â”‚         â”‚                      â””â”€ SYSTEM_ALERT_WINDOW       â”‚
â”‚         â”‚                                                    â”‚
â”‚         â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚     NotificationService              â”‚                  â”‚
â”‚  â”‚  (Foreground, Background, Killed)    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                                                    â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â–¼         â–¼             â–¼            â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚WebSocket â”‚ â”‚Firebaseâ”‚  â”‚CallRepo   â”‚ â”‚NotifMgr  â”‚     â”‚
â”‚  â”‚ Manager  â”‚ â”‚ FCM    â”‚  â”‚           â”‚ â”‚          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                        â”‚                          â”‚
â”‚         â”‚ new_message            â”‚ incoming_call            â”‚
â”‚         â”‚ reaction_updated       â”‚                          â”‚
â”‚         â”‚ friend_request         â”‚                          â”‚
â”‚         â–¼                        â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚NotificationHelperâ”‚     â”‚IncomingCallServiceâ”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                        â”‚                          â”‚
â”‚         â–¼                        â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚     Android Notification Manager      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                        â”‚                          â”‚
â”‚         â–¼                        â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Banner    â”‚         â”‚ Full-Screen â”‚                  â”‚
â”‚  â”‚Notification â”‚         â”‚ CallActivityâ”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Incoming Call Notifications

### Flow Diagram

```
[Call Initiated]
      â”‚
      â–¼
[Firestore: calls collection]
      â”‚
      â–¼
[NotificationService detects via CallRepository]
      â”‚
      â–¼
[Launch IncomingCallService]
      â”‚
      â”œâ”€â–º [Start Foreground Service]
      â”œâ”€â–º [Play Ringtone]
      â”œâ”€â–º [Start Vibration]
      â”œâ”€â–º [Wake Screen]
      â”‚
      â–¼
[Check SYSTEM_ALERT_WINDOW permission]
      â”‚
      â”œâ”€â–º YES â”€â”€â–º [Auto-launch CallActivity]
      â”‚                    â”‚
      â”‚                    â”œâ”€â–º [Replace notification â†’ SILENT]
      â”‚                    â””â”€â–º [Cancel notification when CallActivity opens]
      â”‚
      â””â”€â–º NO â”€â”€â”€â–º [Show HIGH-PRIORITY notification]
                         â”‚
                         â””â”€â–º [User taps â†’ Open CallActivity]
```

### Components

#### 1. **IncomingCallService.java**
- **Type:** Foreground Service
- **Foreground Service Type:** 
  - Android 14+: `FOREGROUND_SERVICE_TYPE_SPECIAL_USE`
  - Android 10-13: `FOREGROUND_SERVICE_TYPE_PHONE_CALL`
- **Responsibilities:**
  - Play ringtone
  - Vibrate device
  - Wake screen
  - Auto-launch CallActivity
  - Manage notification lifecycle

**Key Methods:**
```java
showIncomingCallNotification(Intent intent)
launchCallActivity(String callerId, String callerName, String conversationId, String receiverId, boolean isVideo)
playRingtone()
startVibration()
stopRingtoneAndVibration()
```

#### 2. **CallActivity.java**
- **Responsibilities:**
  - Display full-screen call UI
  - Cancel incoming call notification on open
  - Handle Accept/Reject actions

**Notification Cleanup:**
```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    // ...
    if (isIncoming) {
        CallNotificationHelper.cancelNotification(this, 1001);
        Log.d(TAG, "Cancelled incoming call notification");
    }
}
```

#### 3. **NotificationService.java**
- **Responsibilities:**
  - Listen to Firestore `calls` collection
  - Detect incoming calls
  - Fetch caller information
  - Launch IncomingCallService

**Incoming Call Detection:**
```java
private void setupIncomingCallListener() {
    callRepository.listenToIncomingCalls(receiverId, new OnIncomingCallListener() {
        @Override
        public void onIncomingCall(Call call) {
            // Fetch caller info
            // Launch IncomingCallService
        }
    });
}
```

### Notification States

| State | Notification Type | Visibility | Actions |
|-------|------------------|-----------|---------|
| **Ringing** | HIGH-PRIORITY | âœ… Banner + Sound + Vibration | Accept, Reject |
| **Activity Launched (with permission)** | SILENT (PRIORITY_MIN) | âŒ Hidden | - |
| **Activity Opened** | NONE | âŒ Cancelled | - |
| **Call Connected** | OngoingCallService (LOW) | âŒ Hidden | - |
| **Call Ended** | NONE | âŒ Cancelled | - |

### Intent Extras (Lowercase Keys)

```java
// From NotificationService â†’ IncomingCallService â†’ CallActivity
"call_id"          // String: Call ID
"caller_id"        // String: Caller user ID
"caller_name"      // String: Caller display name
"receiver_id"      // String: Receiver user ID
"conversation_id"  // String: Conversation ID
"is_video"         // Boolean: true for video call
"is_incoming"      // Boolean: true for incoming call
```

---

## Chat Message Notifications

### Flow Diagram

```
[Message Sent]
      â”‚
      â–¼
[Server: POST /api/messages]
      â”‚
      â”œâ”€â–º [Save to Firestore]
      â”œâ”€â–º [Fetch sender name from users collection]
      â”‚
      â–¼
[WebSocket emit: new_message]
  {
    "id": "msg123",
    "conversationId": "conv456",
    "senderId": "user789",
    "senderName": "John Doe",  â—„â”€â”€ CRITICAL
    "type": "text",
    "content": "Hello!"
  }
      â”‚
      â–¼
[NotificationService receives via SocketManager]
      â”‚
      â”œâ”€â–º [Filter: Skip if from currentUser]
      â”œâ”€â–º [Filter: Skip if viewing conversation]
      â”œâ”€â–º [Filter: Skip call-related messages]  â—„â”€â”€ NEW
      â”‚
      â–¼
[NotificationHelper.showMessageNotification()]
      â”‚
      â–¼
[Android Notification Manager]
      â”‚
      â–¼
[Banner Notification with sender name]
```

### Message Filters

```java
// 1. Skip own messages
if (senderId.equals(currentUserId)) return;

// 2. Skip if viewing this conversation
if (conversationId.equals(activeConversationId)) return;

// 3. Skip call-related messages
if ("call".equalsIgnoreCase(messageType) || 
    messageText.contains("Cuá»™c gá»i") ||
    messageText.contains("Missed call") ||
    messageText.contains("Incoming call") ||
    messageText.contains("Outgoing call")) {
    return;
}
```

### Message Type Icons

| Type | Display Text | Icon |
|------|-------------|------|
| `text` | Original text | - |
| `image` | "ğŸ–¼ï¸ HÃ¬nh áº£nh" | ğŸ–¼ï¸ |
| `voice` | "ğŸ¤ Tin nháº¯n thoáº¡i" | ğŸ¤ |
| `file` | "ğŸ“ Tá»‡p tin" | ğŸ“ |
| `sticker` | "ğŸ˜€ NhÃ£n dÃ¡n" | ğŸ˜€ |
| `location` | "ğŸ“ Vá»‹ trÃ­" | ğŸ“ |
| `card` | "ğŸ’¼ Danh thiáº¿p" | ğŸ’¼ |
| `call` | **FILTERED** | âŒ |

### Server-Side Changes (messages.js)

**CRITICAL:** Server must include `senderName` in WebSocket events

```javascript
// Fetch sender name
let senderName = 'Unknown';
const senderDoc = await db.collection('users').doc(req.user.uid).get();
if (senderDoc.exists) {
  const senderData = senderDoc.data();
  senderName = senderData.name || senderData.displayName || 'Unknown';
}

// Include in message
const messageWithId = { ...message, id: messageRef.id, senderName };
io.emit('new_message', messageWithId);
```

---

## Permissions Required

### AndroidManifest.xml

```xml
<!-- Notification Permissions -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
<uses-permission android:name="android.permission.USE_FULL_SCREEN_INTENT" />
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />

<!-- Call Permissions -->
<uses-permission android:name="android.permission.VIBRATE" />

<!-- Foreground Service Types -->
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_DATA_SYNC" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_PHONE_CALL" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_SPECIAL_USE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_MICROPHONE" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE_CAMERA" />
```

### Runtime Permission Requests

#### MainActivity.java

```java
// Android 13+ (API 33+)
private void requestNotificationPermission() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
        if (checkSelfPermission(Manifest.permission.POST_NOTIFICATIONS) 
            != PackageManager.PERMISSION_GRANTED) {
            requestPermissions(
                new String[]{Manifest.permission.POST_NOTIFICATIONS}, 
                REQUEST_CODE_NOTIFICATION
            );
        }
    }
}

// Android 14+ (API 34+)
private void requestFullScreenIntentPermission() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
        NotificationManager nm = getSystemService(NotificationManager.class);
        if (!nm.canUseFullScreenIntent()) {
            Intent intent = new Intent(
                Settings.ACTION_MANAGE_APP_USE_FULL_SCREEN_INTENT
            );
            intent.setData(Uri.parse("package:" + getPackageName()));
            startActivity(intent);
        }
    }
    requestOverlayPermission();
}

// Android 10+ (API 29+) - CRITICAL for background activity launch
private void requestOverlayPermission() {
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
        if (!Settings.canDrawOverlays(this)) {
            Intent intent = new Intent(
                Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
                Uri.parse("package:" + getPackageName())
            );
            startActivity(intent);
            Toast.makeText(this, 
                "Vui lÃ²ng báº­t 'Hiá»ƒn thá»‹ trÃªn á»©ng dá»¥ng khÃ¡c'", 
                Toast.LENGTH_LONG).show();
        }
    }
}
```

### Permission Flow

```
App Launch
    â”‚
    â–¼
[Check POST_NOTIFICATIONS]
    â”‚
    â”œâ”€â–º NOT GRANTED â”€â”€â–º [Request Permission Dialog]
    â”‚
    â–¼
[Check USE_FULL_SCREEN_INTENT]
    â”‚
    â”œâ”€â–º NOT GRANTED â”€â”€â–º [Open Settings]
    â”‚
    â–¼
[Check SYSTEM_ALERT_WINDOW]
    â”‚
    â”œâ”€â–º NOT GRANTED â”€â”€â–º [Open Settings]
    â”‚
    â–¼
[All Permissions Granted] âœ…
```

---

## Cáº¥u HÃ¬nh

### Notification Channels

#### 1. Chat Channel
```java
// ID: "chat_channel"
// Name: "Chat Messages"
// Importance: HIGH
// Sound: Default
// Vibration: Enabled
```

#### 2. Call Channel (IncomingCallService)
```java
// ID: "call_channel"
// Name: "Incoming Calls"
// Importance: HIGH
// Sound: Default ringtone
// Vibration: Pattern [0, 1000, 1000]
```

#### 3. Ongoing Call Channel (OngoingCallService)
```java
// ID: "ongoing_call_channel"
// Name: "Cuá»™c gá»i Ä‘ang diá»…n ra"
// Importance: LOW  â—„â”€â”€ Hidden from tray
// Sound: None
// Vibration: None
// Badge: false
```

### Service Configuration

#### NotificationService
```xml
<service
    android:name=".services.NotificationService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="dataSync" />
```

#### IncomingCallService
```xml
<service
    android:name=".services.IncomingCallService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="specialUse">
    <property
        android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
        android:value="incomingCall" />
</service>
```

#### OngoingCallService
```xml
<service
    android:name=".services.OngoingCallService"
    android:enabled="true"
    android:exported="false"
    android:foregroundServiceType="camera|microphone" />
```

---

## Testing Guide

### 1. Test Incoming Call (App Background)

**Setup:**
1. User A: Login
2. User B: Login
3. User B: Press Home (app to background)

**Test:**
1. User A â†’ Call User B (video or voice)
2. **Expected Results:**
   - âœ… User B's screen wakes up
   - âœ… CallActivity pops up full-screen
   - âœ… Ringtone plays
   - âœ… Device vibrates
   - âœ… No banner notification (replaced with silent)
   - âœ… Caller name displays correctly

**Verify Logs:**
```
IncomingCallService: Started with foreground service type: specialUse
IncomingCallService: Launched CallActivity successfully
IncomingCallService: Notification replaced with silent version
CallActivity: Cancelled incoming call notification
```

### 2. Test Incoming Call (App Killed)

**Setup:**
1. User B: Swipe away app from Recent Apps

**Test:**
1. User A â†’ Call User B
2. **Expected Results:**
   - âœ… Same as background test
   - âœ… App launches automatically

### 3. Test Chat Notification

**Setup:**
1. User B: App in background or killed
2. User B: NOT viewing conversation with User A

**Test:**
1. User A â†’ Send message "Hello"
2. **Expected Results:**
   - âœ… Banner notification shows
   - âœ… Sender name: "User A" (NOT "Unknown")
   - âœ… Message content: "Hello"

### 4. Test Call Message Filter

**Setup:**
1. User A calls User B
2. Call ends (missed/rejected/completed)

**Test:**
1. Check notifications
2. **Expected Results:**
   - âŒ NO notification for "Cuá»™c gá»i Ä‘áº¿n"
   - âŒ NO notification for "Cuá»™c gá»i Ä‘i"
   - âŒ NO "Unknown" notification

### 5. Test OngoingCallService Notification

**Setup:**
1. User A calls User B
2. User B accepts
3. Pull down notification shade

**Test:**
1. Check notifications
2. **Expected Results:**
   - âŒ NO visible notification in notification tray
   - âœ… Service still running (check Settings â†’ Apps â†’ ZaloClone)

---

## Troubleshooting

### Issue 1: "Unknown" Notification After Call

**Symptom:**
- Notification shows "Unknown â€¢ now" after call ends

**Cause:**
- Server not sending `senderName` in WebSocket event
- OR call message not filtered

**Solution:**
```javascript
// server/src/routes/messages.js
let senderName = 'Unknown';
const senderDoc = await db.collection('users').doc(req.user.uid).get();
if (senderDoc.exists) {
  senderName = senderDoc.data().name || senderDoc.data().displayName;
}
const messageWithId = { ...message, id: messageRef.id, senderName };
```

**AND**
```java
// NotificationService.java
if ("call".equalsIgnoreCase(messageType) || 
    messageText.contains("Cuá»™c gá»i")) {
    return;  // Skip
}
```

### Issue 2: CallActivity Not Popping Up

**Symptom:**
- Only notification shows, no full-screen activity

**Cause:**
- Missing `SYSTEM_ALERT_WINDOW` permission

**Solution:**
1. Go to Settings â†’ Apps â†’ ZaloClone
2. Enable "Display over other apps"
3. OR run `requestOverlayPermission()` in MainActivity

**Verify:**
```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
    boolean canDraw = Settings.canDrawOverlays(context);
    Log.d(TAG, "Can draw overlays: " + canDraw);
}
```

### Issue 3: SecurityException - Foreground Service Type

**Error:**
```
java.lang.SecurityException: Permission Denial: startForeground 
requires android.permission.FOREGROUND_SERVICE_PHONE_CALL
```

**Cause:**
- Wrong foreground service type for Android version

**Solution:**
Use `specialUse` for Android 14+:
```xml
<service
    android:foregroundServiceType="specialUse">
    <property
        android:name="android.app.PROPERTY_SPECIAL_USE_FGS_SUBTYPE"
        android:value="incomingCall" />
</service>
```

```java
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.UPSIDE_DOWN_CAKE) {
    startForeground(NOTIFICATION_ID, notification, 
        ServiceInfo.FOREGROUND_SERVICE_TYPE_SPECIAL_USE);
}
```

### Issue 4: Ongoing Call Notification Visible

**Symptom:**
- "Cuá»™c gá»i Ä‘ang diá»…n ra" notification shows in tray

**Cause:**
- Channel importance too high

**Solution:**
```java
NotificationChannel channel = new NotificationChannel(
    CHANNEL_ID,
    "Cuá»™c gá»i Ä‘ang diá»…n ra",
    NotificationManager.IMPORTANCE_LOW  // â† LOW, not HIGH
);
channel.setShowBadge(false);
```

### Issue 5: Notification After Call Ended

**Symptom:**
- Silent notification persists after call ends

**Cause:**
- IncomingCallService not stopped properly

**Solution:**
```java
// CallActivity.java
@Override
protected void onDestroy() {
    super.onDestroy();
    // Stop IncomingCallService
    Intent serviceIntent = new Intent(this, IncomingCallService.class);
    stopService(serviceIntent);
}
```

---

## Known Issues

### 1. Android 10+ Background Restrictions

**Platform:** Android 10 (API 29) and above

**Description:**
Starting activities from background is heavily restricted. Without `SYSTEM_ALERT_WINDOW`, CallActivity cannot pop up.

**Workaround:**
âœ… Request `SYSTEM_ALERT_WINDOW` permission

**Status:** Fixed

---

### 2. Notification Permission Dialog (Android 13+)

**Platform:** Android 13 (API 33) and above

**Description:**
`POST_NOTIFICATIONS` is runtime permission. Users can deny.

**Impact:**
If denied, NO notifications will show (chat, calls, friend requests).

**Workaround:**
- Check permission on app start
- Show educational UI explaining why needed
- Deep link to Settings

**Status:** Working as designed

---

### 3. Full-Screen Intent Suppressed by DND

**Platform:** All Android versions

**Description:**
If device in Do Not Disturb mode, full-screen intents may not show.

**Impact:**
Incoming call may only show as notification (not full-screen).

**Workaround:**
None (OS limitation)

**Status:** Expected behavior

---

### 4. Manufacturer-Specific Battery Optimization

**Platform:** Xiaomi, Oppo, Vivo, etc.

**Description:**
Aggressive battery savers may kill `NotificationService` even when foreground.

**Impact:**
Notifications may not arrive when app killed.

**Workaround:**
- Guide users to disable battery optimization for ZaloClone
- Use Firebase Cloud Messaging (FCM) as fallback

**Status:** Out of scope (manufacturer limitation)

---

## Performance Considerations

### Battery Impact

| Component | Battery Usage | Mitigation |
|-----------|--------------|-----------|
| NotificationService | Low (WebSocket idle) | Use WakeLock only when needed |
| IncomingCallService | Medium (Ringtone + Vibration) | Auto-stop after 60s |
| OngoingCallService | Low (PARTIAL_WAKE_LOCK) | Release on call end |

### Network Impact

| Event | Frequency | Data Usage |
|-------|----------|-----------|
| WebSocket heartbeat | ~30s | <1KB per minute |
| Incoming call detection | Real-time | ~500 bytes per call |
| Message notification | Per message | ~1KB per message |

### Memory Impact

- **NotificationService:** ~5-10 MB RAM (persistent)
- **IncomingCallService:** ~3-5 MB RAM (temporary)
- **OngoingCallService:** ~2-3 MB RAM (during call)

**Total:** ~10-18 MB additional RAM when all services active

---

## Future Improvements

### Phase 1 (High Priority)
- [ ] Add FCM fallback for when WebSocket disconnects
- [ ] Implement notification grouping (multiple messages)
- [ ] Add quick reply from notification
- [ ] Support Android Auto

### Phase 2 (Medium Priority)
- [ ] Custom notification sounds per contact
- [ ] Notification LED color customization
- [ ] Notification scheduling (quiet hours)
- [ ] Notification history

### Phase 3 (Low Priority)
- [ ] Notification analytics
- [ ] A/B testing different notification styles
- [ ] Machine learning for smart notification filtering

---

## References

### Android Documentation
- [Notifications Overview](https://developer.android.com/develop/ui/views/notifications)
- [Foreground Services](https://developer.android.com/develop/background-work/services/foreground-services)
- [Background Activity Launch Restrictions](https://developer.android.com/guide/components/activities/background-starts)

### Code References
- `NotificationService.java` - Main notification orchestrator
- `IncomingCallService.java` - Incoming call handler
- `CallNotificationHelper.java` - Notification creation utilities
- `NotificationHelper.java` - Chat notification utilities
- `MainActivity.java` - Permission requests

---

## Contact & Support

**Team:** ZaloClone Development Team  
**Documentation Maintained By:** AI Assistant  
**Last Review:** 2025-12-27

---

**Â© 2025 ZaloClone - Notification System Documentation**
