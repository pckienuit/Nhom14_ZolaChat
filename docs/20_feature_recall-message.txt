================================================================================
T√çNH NƒÇNG THU H·ªíI TIN NH·∫ÆN (RECALL MESSAGE)
================================================================================
Ng√†y t·∫°o: 2025-12-20
Phi√™n b·∫£n: 1.0

================================================================================
1. T·ªîNG QUAN
================================================================================

T√≠nh nƒÉng cho ph√©p ng∆∞·ªùi d√πng thu h·ªìi (recall) tin nh·∫Øn ƒë√£ g·ª≠i trong v√≤ng 1 gi·ªù.
Tin nh·∫Øn sau khi thu h·ªìi s·∫Ω kh√¥ng b·ªã x√≥a m√† ƒë∆∞·ª£c ƒë√°nh d·∫•u v√† hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng
placeholder v·ªõi n·ªôi dung "Tin nh·∫Øn n√†y ƒë√£ b·ªã thu h·ªìi".

ƒê·∫∑c ƒëi·ªÉm:
- Ch·ªâ ng∆∞·ªùi g·ª≠i m·ªõi c√≥ quy·ªÅn thu h·ªìi tin nh·∫Øn c·ªßa m√¨nh
- Ch·ªâ c√≥ th·ªÉ thu h·ªìi trong v√≤ng 1 gi·ªù sau khi g·ª≠i
- Tin nh·∫Øn ƒë√£ thu h·ªìi kh√¥ng th·ªÉ thu h·ªìi l·∫°i
- C·∫£ hai b√™n ƒë·ªÅu th·∫•y tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi (real-time sync)

================================================================================
2. KI·∫æN TR√öC & LU·ªíNG HO·∫†T ƒê·ªòNG
================================================================================

2.1. Data Flow:
    User long-press message
           |
           v
    Context Menu hi·ªÉn th·ªã "üîÑ Thu h·ªìi" (n·∫øu canBeRecalled = true)
           |
           v
    User ch·ªçn "Thu h·ªìi"
           |
           v
    showRecallConfirmDialog() - Hi·ªÉn th·ªã dialog x√°c nh·∫≠n
           |
           v
    User x√°c nh·∫≠n
           |
           v
    RoomActivity.recallMessage()
           |
           v
    ChatRepository.recallMessage() - Update Firestore
           |
           v
    Firestore listener trigger
           |
           v
    MessageAdapter.updateMessages() - DiffUtil detect change
           |
           v
    getItemViewType() returns VIEW_TYPE_RECALLED_SENT/RECEIVED
           |
           v
    UI hi·ªÉn th·ªã placeholder thu h·ªìi

2.2. Business Rules (trong Message.canBeRecalled()):
    - message.getSenderId().equals(currentUserId) : Ch·ªâ sender
    - !message.isRecalled() : Ch∆∞a b·ªã thu h·ªìi
    - (currentTime - timestamp) < 1 hour : Trong v√≤ng 1 gi·ªù

================================================================================
3. FILES ƒê√É THAY ƒê·ªîI
================================================================================

3.1. MODEL:
    app/src/main/java/com/example/doan_zaloclone/models/Message.java
    - Field: isRecalled (boolean)
    - Method: isRecalled(), getIsRecalled() (Firestore compatibility)
    - Method: setRecalled(), setIsRecalled() (Firestore compatibility)
    - Method: canBeRecalled(String currentUserId) - Ki·ªÉm tra ƒëi·ªÅu ki·ªán thu h·ªìi

3.2. REPOSITORY:
    app/src/main/java/com/example/doan_zaloclone/repository/ChatRepository.java
    - Method: recallMessage(conversationId, messageId, callback)
    - Interface: RecallMessageCallback (onSuccess, onError)

3.3. UI - ADAPTER:
    app/src/main/java/com/example/doan_zaloclone/ui/room/MessageAdapter.java
    - Constants: VIEW_TYPE_RECALLED_SENT = 8, VIEW_TYPE_RECALLED_RECEIVED = 9
    - Interface: OnMessageRecallListener
    - Method: setOnMessageRecallListener()
    - Class: RecalledMessageViewHolder
    - Updated: getItemViewType() - Check isRecalled first
    - Updated: onCreateViewHolder() - Inflate recalled layouts
    - Updated: showMessageContextMenu() - Early return if recalled

3.4. UI - ACTIVITY:
    app/src/main/java/com/example/doan_zaloclone/ui/room/RoomActivity.java
    - Method: showRecallConfirmDialog(Message) - AlertDialog x√°c nh·∫≠n
    - Method: recallMessage(Message) - G·ªçi repository
    - Listener: OnMessageRecallListener trong setupRecyclerView()

3.5. LAYOUTS:
    app/src/main/res/layout/item_message_recalled_sent.xml
    - CƒÉn ph·∫£i (gravity="end")
    - M√†u x√°m (#E0E0E0), kh√¥ng ƒë·ªï b√≥ng (cardElevation="0dp")
    - Ch·ªØ in nghi√™ng, m√†u x√°m (#757575)

    app/src/main/res/layout/item_message_recalled_received.xml
    - CƒÉn tr√°i (gravity="start")
    - C√πng style v·ªõi sent

3.6. FIRESTORE SECURITY RULES:
    docs/04_config_firestore-security-rules.txt
    - Updated: Messages allow update if sender matches

================================================================================
4. FIRESTORE SECURITY RULES
================================================================================

C·∫ßn c·∫≠p nh·∫≠t rules cho messages subcollection ƒë·ªÉ cho ph√©p sender update:

    match /conversations/{conversationId}/messages/{messageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      // Allow update only for message sender (for recall functionality)
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.senderId;
      allow delete: if false;
    }

L∆ØU √ù: Ch·ªâ gi·ªØ M·ªòT rule cho messages, kh√¥ng duplicate!

================================================================================
5. FIRESTORE DATA STRUCTURE
================================================================================

Collection: conversations/{conversationId}/messages/{messageId}

Sau khi thu h·ªìi:
{
    "id": "messageId",
    "senderId": "userId",
    "content": "",                  // Cleared
    "type": "TEXT",
    "timestamp": 1703062800000,
    "isRecalled": true,             // Marked as recalled
    ...other fields
}

================================================================================
6. UI/UX SPECIFICATIONS
================================================================================

6.1. Context Menu:
    - Menu item: "üîÑ Thu h·ªìi"
    - Ch·ªâ hi·ªÉn th·ªã khi canBeRecalled() = true
    - Kh√¥ng hi·ªÉn th·ªã cho tin nh·∫Øn ƒë√£ thu h·ªìi

6.2. Confirmation Dialog:
    - Title: "Thu h·ªìi tin nh·∫Øn"
    - Message: "B·∫°n c√≥ ch·∫Øc mu·ªën thu h·ªìi tin nh·∫Øn n√†y?"
    - Buttons: "Thu h·ªìi" (positive), "H·ªßy" (negative)

6.3. Recalled Message Display:
    - Background: X√°m (#E0E0E0)
    - Elevation: 0dp (kh√¥ng ƒë·ªï b√≥ng)
    - Text: "Tin nh·∫Øn n√†y ƒë√£ b·ªã thu h·ªìi"
    - Text style: Italic, m√†u x√°m (#757575)
    - Position: CƒÉn ph·∫£i (sent) ho·∫∑c cƒÉn tr√°i (received)
    - Interaction: Kh√¥ng c√≥ (clickable=false, focusable=false)
    - Context menu: Kh√¥ng hi·ªÉn th·ªã

6.4. Toast Messages:
    - Success: "ƒê√£ thu h·ªìi tin nh·∫Øn"
    - Error: "L·ªói: {error message}"

================================================================================
7. INTERFACES & CALLBACKS
================================================================================

7.1. MessageAdapter.OnMessageRecallListener:
    public interface OnMessageRecallListener {
        void onRecallMessage(Message message);
    }

7.2. ChatRepository.RecallMessageCallback:
    public interface RecallMessageCallback {
        void onSuccess();
        void onError(String error);
    }

================================================================================
8. TESTING CHECKLIST
================================================================================

[ ] Thu h·ªìi tin nh·∫Øn text th√†nh c√¥ng
[ ] Thu h·ªìi tin nh·∫Øn image th√†nh c√¥ng
[ ] Thu h·ªìi tin nh·∫Øn file th√†nh c√¥ng
[ ] Tin nh·∫Øn > 1 gi·ªù kh√¥ng c√≥ option thu h·ªìi
[ ] Tin nh·∫Øn c·ªßa ng∆∞·ªùi kh√°c kh√¥ng c√≥ option thu h·ªìi
[ ] Tin nh·∫Øn ƒë√£ thu h·ªìi kh√¥ng c√≥ option thu h·ªìi
[ ] Hi·ªÉn th·ªã ƒë√∫ng v·ªã tr√≠ (cƒÉn tr√°i/ph·∫£i)
[ ] Kh√¥ng c√≥ context menu cho tin nh·∫Øn ƒë√£ thu h·ªìi
[ ] Real-time sync - ng∆∞·ªùi nh·∫≠n th·∫•y tin nh·∫Øn ƒë√£ thu h·ªìi
[ ] Dialog x√°c nh·∫≠n ho·∫°t ƒë·ªông ƒë√∫ng
[ ] Toast messages hi·ªÉn th·ªã ƒë√∫ng
[ ] Firestore security rules ƒë√∫ng

================================================================================
9. KNOWN LIMITATIONS
================================================================================

- Kh√¥ng th·ªÉ undo vi·ªác thu h·ªìi
- Tin nh·∫Øn thu h·ªìi v·∫´n t·ªìn t·∫°i trong database (ch·ªâ ·∫©n n·ªôi dung)
- Kh√¥ng c√≥ th√¥ng b√°o push khi tin nh·∫Øn b·ªã thu h·ªìi
- Reply preview ƒë·∫øn tin nh·∫Øn ƒë√£ thu h·ªìi v·∫´n hi·ªÉn th·ªã n·ªôi dung c≈© (n·∫øu ƒë√£ cache)

================================================================================
10. FUTURE IMPROVEMENTS
================================================================================

- Th√™m animation khi thu h·ªìi
- Th√™m notification push khi tin nh·∫Øn b·ªã thu h·ªìi
- Update reply preview khi original message b·ªã thu h·ªìi
- Cho ph√©p admin group thu h·ªìi tin nh·∫Øn c·ªßa member
- C·∫•u h√¨nh th·ªùi gian cho ph√©p thu h·ªìi (hi·ªán t·∫°i hardcode 1 gi·ªù)

================================================================================
