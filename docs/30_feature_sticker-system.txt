================================================================================
TÃNH NÄ‚NG STICKER SYSTEM (Sticker System Feature)
================================================================================

NGÃ€Y Táº O: 23/12/2024
LOáº I: Feature
TÃNH NÄ‚NG: Há»‡ thá»‘ng sticker vá»›i AI background removal, store, vÃ  custom creation
KIáº¾N TRÃšC: MVVM + Repository Pattern
DEPENDENCIES: UCrop, OkHttp, Glide, Firebase Firestore

================================================================================
1. Tá»”NG QUAN
================================================================================

Há»‡ thá»‘ng sticker toÃ n diá»‡n cho phÃ©p:
- Gá»­i/nháº­n sticker trong chat
- Táº¡o custom sticker tá»« áº£nh (vá»›i AI xÃ³a ná»n)
- Browse vÃ  download sticker packs tá»« store
- Quáº£n lÃ½ sticker cÃ¡ nhÃ¢n

LUá»’NG HOáº T Äá»˜NG CHÃNH:
1. User â†’ Sticker Picker â†’ Chá»n sticker â†’ Gá»­i trong chat
2. User â†’ Create Sticker â†’ Pick áº£nh â†’ AI remove BG â†’ Upload VPS â†’ LÆ°u Firestore
3. User â†’ Sticker Store â†’ Browse packs â†’ Download â†’ DÃ¹ng trong picker

================================================================================
2. KIáº¾N TRÃšC VÃ€ COMPONENTS
================================================================================

2.1. DATA LAYER
---------------

Models:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sticker.java                                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - id: String                                                                â”‚
â”‚ - packId: String                                                            â”‚
â”‚ - imageUrl: String                                                          â”‚
â”‚ - thumbnailUrl: String                                                      â”‚
â”‚ - isAnimated: boolean (supports WebP/GIF)                                   â”‚
â”‚ - format: String (PNG/JPEG/WEBP/GIF)                                        â”‚
â”‚ - creatorId: String                                                         â”‚
â”‚ - tags: List<String>                                                        â”‚
â”‚ - createdAt: long                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StickerPack.java                                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - id: String                                                                â”‚
â”‚ - name: String                                                              â”‚
â”‚ - description: String                                                       â”‚
â”‚ - iconUrl: String                                                           â”‚
â”‚ - type: String (OFFICIAL/USER/TRENDING)                                     â”‚
â”‚ - creatorId: String                                                         â”‚
â”‚ - stickerCount: int                                                         â”‚
â”‚ - downloadCount: long                                                       â”‚
â”‚ - isPublished: boolean                                                      â”‚
â”‚ - isFree: boolean                                                           â”‚
â”‚ - price: double                                                             â”‚
â”‚ - createdAt: long                                                           â”‚
â”‚ - updatedAt: long                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Message.java (Extended)                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + TYPE_STICKER: String = "sticker"                                          â”‚
â”‚ + stickerId: String                                                         â”‚
â”‚ + stickerPackId: String                                                     â”‚
â”‚ + stickerUrl: String                                                        â”‚
â”‚ + isStickerAnimated: boolean                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


2.2. REPOSITORY LAYER
---------------------

StickerRepository.java:
- getInstance(): Singleton pattern
- getOfficialPacks(): LiveData<Resource<List<StickerPack>>>
- getUserSavedPacks(userId): LiveData<Resource<List<StickerPack>>>
- getStickersInPack(packId): LiveData<Resource<List<Sticker>>>
- getRecentStickers(userId): LiveData<Resource<List<Sticker>>>
- uploadCustomSticker(uri, userId, fileName, callback): void
- getOrCreateUserStickerPack(userId, callback): void  â† packId = userId
- addStickerToPack(packId, sticker, onSuccess): void
- deleteSticker(packId, stickerId, onSuccess): void   â† Má»šI
- getFeaturedPacks(): LiveData<Resource<List<StickerPack>>>
- getTrendingPacks(): LiveData<Resource<List<StickerPack>>>
- getNewPacks(): LiveData<Resource<List<StickerPack>>>


2.3. UI LAYER
-------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StickerPickerFragment (BottomSheet)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Horizontal pack tabs vá»›i selection indicator                              â”‚
â”‚ - ViewPager2 cho swipeable sticker grids                                   â”‚
â”‚ - Recent stickers tab (history icon)                                        â”‚
â”‚ - Action buttons: Add Sticker, Store, My Stickers                           â”‚
â”‚                                                                             â”‚
â”‚ Adapters:                                                                   â”‚
â”‚ - StickerPackTabAdapter: Pack tabs                                         â”‚
â”‚ - StickerGridAdapter: 4-column grid                                        â”‚
â”‚ - StickerPagerAdapter: ViewPager2 pages                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CreateStickerActivity                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Image picker (Android 13+ permissions)                                    â”‚
â”‚ - UCrop integration (1:1 square crop, max 512x512)                         â”‚
â”‚ - AI background removal (Clipdrop + rembg fallback)                        â”‚
â”‚ - Checkerboard preview for transparency                                     â”‚
â”‚ - Upload to VPS vá»›i progress callback                                       â”‚
â”‚ - Auto-create "My Stickers" pack                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StickerStoreActivity                                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Sections:                                                                   â”‚
â”‚ - ğŸ“ Sticker cá»§a tÃ´i (click â†’ MyStickerActivity)                           â”‚
â”‚ - â­ Featured (horizontal scroll)                                           â”‚
â”‚ - ğŸ”¥ Trending (grid, sorted by downloads)                                  â”‚
â”‚ - ğŸ†• New (grid, sorted by createdAt)                                        â”‚
â”‚                                                                             â”‚
â”‚ Features:                                                                   â”‚
â”‚ - Gradient blue header vá»›i SwipeRefreshLayout                               â”‚
â”‚ - Download pack â†’ Add to user collection                                    â”‚
â”‚ - Pack click â†’ Preview detail (planned)                                     â”‚
â”‚ - Auto increment download count                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MyStickerActivity (Má»šI - 27/12/2024)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - Hiá»ƒn thá»‹ sticker cÃ¡ nhÃ¢n (packId = userId)                                â”‚
â”‚ - Grid layout 4 cá»™t vá»›i SwipeRefreshLayout                                  â”‚
â”‚ - Edit mode (long-press) vá»›i nÃºt xÃ³a                                        â”‚
â”‚ - NÃºt táº¡o sticker má»›i â†’ CreateStickerActivity                              â”‚
â”‚ - Empty state khi chÆ°a cÃ³ sticker                                           â”‚
â”‚ - Gradient blue header phÃ¹ há»£p UI Zalo                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MessageAdapter - StickerMessageViewHolder                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - VIEW_TYPE_STICKER_SENT (18)                                               â”‚
â”‚ - VIEW_TYPE_STICKER_RECEIVED (19)                                           â”‚
â”‚ - Glide loading with animated support (WebP/GIF)                            â”‚
â”‚ - Pin indicator                                                             â”‚
â”‚ - Context menu (pin, reply, forward, recall)                                â”‚
â”‚ - Sender name in group chats                                                â”‚
â”‚ - Size: 180x180dp                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


2.4. SERVICES
-------------

BackgroundRemovalService.java:
- Primary: Clipdrop API (100 free requests/month)
- Fallback: rembg self-hosted on VPS
- API Key: 4a4976c484431ca4a89cb1ab2a8f3ea278228d9aef74327cb898f302fee92a332197087247ed23badd193ec852e709b2
- removeBackground(uri, context, callback): void
- Callbacks: onSuccess(Bitmap, String), onError(String), onProgress(int)

================================================================================
3. VPS CONFIGURATION
================================================================================

3.1. SERVER DETAILS
-------------------

IP: 163.61.182.20
OS: Ubuntu 20.04 LTS
RAM: 2GB
Storage: 50GB SSD

Services Running:
1. Apache2 - Static file serving (port 80)
2. Node.js Upload Service (port 3000)
3. rembg AI Service (port 5000) - Optional

3.2. ENDPOINTS
--------------

Static Files:
GET http://163.61.182.20/stickers/[filename]
â†’ Serve sticker images

Upload API:
POST http://163.61.182.20/api/stickers/upload
â†’ Body: multipart/form-data
   - sticker: File
   - userId: String
â†’ Response: {"success": true, "url": "http://..."}

Health Check:
GET http://163.61.182.20/api/stickers/health
â†’ Response: {"status": "ok", "timestamp": ...}

Background Removal (Fallback):
POST http://163.61.182.20/api/rembg/remove-background
â†’ Body: multipart/form-data
   - image: File
â†’ Response: PNG file with transparent background


3.3. DIRECTORY STRUCTURE
------------------------

/var/www/html/stickers/    # Static sticker files
/opt/sticker-upload/       # Node.js upload service
/opt/rembg/                # Python rembg service (optional)


3.4. SETUP SCRIPT
-----------------

File: scripts/setup_vps_sticker_server.sh

Chá»©c nÄƒng:
- Install Apache2, Node.js, Python3
- Configure upload service (Express.js)
- Setup rembg service (FastAPI)
- Configure memory limits (2GB RAM optimization)
- Create systemd services

Cháº¡y script:
```bash
chmod +x scripts/setup_vps_sticker_server.sh
sudo ./scripts/setup_vps_sticker_server.sh
```

Kiá»ƒm tra services:
```bash
sudo systemctl status apache2
sudo systemctl status sticker-upload
sudo systemctl status rembg  # If enabled
```

================================================================================
4. FIRESTORE SECURITY RULES
================================================================================

4.1. PERSONAL STICKER PACK (Má»šI - 27/12/2024)
----------------------------------------------

THIáº¾T Káº¾:
- Má»—i user cÃ³ 1 pack sticker cÃ¡ nhÃ¢n duy nháº¥t
- Pack ID = User ID (dá»… truy váº¥n, khÃ´ng cáº§n query)
- ÄÆ°á»ng dáº«n: stickerPacks/{userId}/stickers/{stickerId}

LOGIC Táº O PACK:
1. Kiá»ƒm tra document stickerPacks/{userId} cÃ³ tá»“n táº¡i khÃ´ng
2. Náº¿u cÃ³ â†’ dÃ¹ng pack Ä‘Ã³
3. Náº¿u khÃ´ng â†’ táº¡o pack má»›i vá»›i packId = userId

Báº¢O Máº¬T:
- User chá»‰ cÃ³ thá»ƒ Ä‘á»c/ghi pack cá»§a chÃ­nh mÃ¬nh
- User KHÃ”NG thá»ƒ truy cáº­p pack cÃ¡ nhÃ¢n cá»§a ngÆ°á»i khÃ¡c
- Admin cÃ³ quyá»n Ä‘á»c/ghi táº¥t cáº£ packs

4.2. SECURITY RULES CHI TIáº¾T
-----------------------------

```javascript
// Admin check function
function isAdmin() {
    return request.auth.token.admin == true;
}

match /stickerPacks/{packId} {
    // READ RULES:
    // - Official packs (type != 'user'): anyone authenticated can read
    // - Personal packs (packId = userId): only owner OR admin can read
    allow read: if request.auth != null && 
                (resource.data.type != 'user' || 
                 resource.data.creatorId == request.auth.uid ||
                 packId == request.auth.uid ||
                 isAdmin());
    
    // CREATE RULES:
    // - Personal packs: packId MUST equal userId
    // - Official packs: admin only
    allow create: if request.auth != null && 
                  ((request.resource.data.type == 'user' &&
                    request.resource.data.creatorId == request.auth.uid &&
                    packId == request.auth.uid) ||
                   isAdmin());
    
    // UPDATE/DELETE RULES:
    // - Owner can update/delete their pack
    // - Admin can update/delete any pack
    allow update, delete: if request.auth != null && 
                          (resource.data.creatorId == request.auth.uid ||
                           packId == request.auth.uid ||
                           isAdmin());
    
    // STICKERS SUBCOLLECTION
    match /stickers/{stickerId} {
        // Read: only owner OR admin can read stickers in personal pack
        allow read: if request.auth != null && 
                    (get(/databases/$(database)/documents/stickerPacks/$(packId)).data.type != 'user' ||
                     get(/databases/$(database)/documents/stickerPacks/$(packId)).data.creatorId == request.auth.uid ||
                     packId == request.auth.uid ||
                     isAdmin());
        
        // Write: only owner OR admin can write stickers in personal pack
        allow write: if request.auth != null && 
                     (packId == request.auth.uid ||
                      get(/databases/$(database)/documents/stickerPacks/$(packId)).data.creatorId == request.auth.uid ||
                      isAdmin());
    }
}
```

4.3. Báº¢NG TÃ“M Táº®T QUYá»€N
------------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Loáº¡i Pack          â”‚ User thÆ°á»ng     â”‚ Owner           â”‚ Admin           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Official packs     â”‚ âœ… Read         â”‚ âœ… Read         â”‚ âœ… Full         â”‚
â”‚ Personal pack      â”‚ âŒ Blocked      â”‚ âœ… Full         â”‚ âœ… Full         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4.4. USER SAVED PACKS & RECENT STICKERS
----------------------------------------

```javascript
match /users/{userId}/savedStickerPacks/{packId} {
    allow read, write: if request.auth.uid == userId;
}

match /users/{userId}/recentStickers/{stickerId} {
    allow read, write: if request.auth.uid == userId;
}
```

4.5. SET ADMIN CLAIM
--------------------

Äá»ƒ cáº¥p quyá»n admin cho user (cháº¡y trÃªn server vá»›i Firebase Admin SDK):

```javascript
const admin = require('firebase-admin');
admin.auth().setCustomUserClaims(uid, { admin: true });
```

================================================================================
5. MY STICKER ACTIVITY (Má»šI - 27/12/2024)
================================================================================

5.1. Tá»”NG QUAN
--------------

MyStickerActivity hiá»ƒn thá»‹ sticker cÃ¡ nhÃ¢n cá»§a user hiá»‡n táº¡i.

ÄÆ°á»ng dáº«n files:
- Activity: ui/sticker/MyStickerActivity.java
- Adapter: ui/sticker/MyStickerAdapter.java
- Layout: res/layout/activity_my_sticker.xml
- Item Layout: res/layout/item_my_sticker.xml

5.2. TÃNH NÄ‚NG
--------------

1. Hiá»ƒn thá»‹ sticker cÃ¡ nhÃ¢n (packId = userId)
2. Pull-to-refresh
3. Grid layout 4 cá»™t
4. Edit mode vá»›i long-press Ä‘á»ƒ xÃ³a sticker
5. NÃºt táº¡o sticker má»›i (má»Ÿ CreateStickerActivity)
6. Empty state khi chÆ°a cÃ³ sticker
7. Äáº¿m sá»‘ lÆ°á»£ng sticker

5.3. UI DESIGN
--------------

- Header: Gradient blue (#0084FF) vá»›i nÃºt back, title, nÃºt táº¡o
- Background: Light gray (#F5F5F5)
- Cards: White vá»›i corner radius 8dp
- Delete button: Red circle (#F44336) vá»›i icon delete

5.4. LUá»’NG HOáº T Äá»˜NG
--------------------

1. User má»Ÿ MyStickerActivity tá»« StickerStoreActivity hoáº·c StickerPickerFragment
2. Activity load stickers tá»« stickerPacks/{userId}/stickers
3. Hiá»ƒn thá»‹ grid sticker hoáº·c empty state
4. User long-press Ä‘á»ƒ vÃ o edit mode â†’ hiá»‡n nÃºt xÃ³a
5. User click nÃºt xÃ³a â†’ confirm dialog â†’ xÃ³a sticker
6. User click nÃºt + â†’ má»Ÿ CreateStickerActivity
7. Sau khi táº¡o sticker, quay láº¡i vÃ  reload list

5.5. CODE SNIPPETS
------------------

Load stickers (chá»‰ load pack cá»§a user hiá»‡n táº¡i):
```java
// Use userId as packId for personal stickers
stickerRepository.getStickersInPack(currentUserId).observe(this, resource -> {
    if (resource.isSuccess()) {
        List<Sticker> stickers = resource.getData();
        adapter.updateStickers(stickers);
    }
});
```

Delete sticker:
```java
stickerRepository.deleteSticker(currentUserId, sticker.getId(), () -> {
    Toast.makeText(this, "ÄÃ£ xÃ³a sticker", Toast.LENGTH_SHORT).show();
    loadMyStickers(); // Reload
});
```

================================================================================
6. HÆ¯á»šNG DáºªN ADMIN - UPLOAD STICKER PACKS
================================================================================

5.1. CÃ€I Äáº¶T DEPENDENCIES
--------------------------

Install Python requirements:
```bash
pip install firebase-admin requests pillow
```

5.2. ADMIN SCRIPT
-----------------

File: scripts/admin_upload_sticker_pack.py

Chá»©c nÄƒng:
- Upload batch stickers lÃªn VPS
- Táº¡o sticker pack trong Firestore
- Auto-generate thumbnails
- Set pack metadata

Usage:
```bash
python scripts/admin_upload_sticker_pack.py \
  --pack-name "Cute Animals" \
  --description "Adorable animal stickers" \
  --type official \
  --stickers-dir ./sticker_images/ \
  --icon ./pack_icon.png
```

Parameters:
- --pack-name: TÃªn gÃ³i sticker
- --description: MÃ´ táº£
- --type: official/user/trending
- --stickers-dir: ThÆ° má»¥c chá»©a sticker images
- --icon: Icon cho pack (512x512 recommended)
- --tags: Tags (comma-separated)

Output:
- Upload stickers â†’ VPS
- Create pack document â†’ Firestore
- Create sticker documents â†’ Firestore subcollection
- Print pack ID vÃ  URLs


5.3. MANUAL UPLOAD QUA FIRESTORE CONSOLE
-----------------------------------------

BÆ°á»›c 1: Upload Images to VPS
```bash
# Using curl
for file in sticker_images/*.png; do
  curl -X POST http://163.61.182.20/api/stickers/upload \
    -F "sticker=@$file" \
    -F "userId=admin_upload"
done
```

BÆ°á»›c 2: Create Pack Document

Collection: stickerPacks
Document ID: [auto-generated hoáº·c custom]

Fields:
```
{
  "id": "pack_001",
  "name": "Pack Name",
  "description": "Pack description",
  "type": "official",
  "iconUrl": "http://163.61.182.20/stickers/pack_icon.png",
  "creatorId": "admin",
  "stickerCount": 24,
  "downloadCount": 0,
  "isPublished": true,
  "isFree": true,
  "price": 0,
  "createdAt": [timestamp],
  "updatedAt": [timestamp]
}
```

BÆ°á»›c 3: Create Sticker Documents

Subcollection: stickerPacks/{packId}/stickers
Document ID: [auto-generated]

Fields (for each sticker):
```
{
  "id": "sticker_001",
  "packId": "pack_001",
  "imageUrl": "http://163.61.182.20/stickers/sticker1.png",
  "thumbnailUrl": "http://163.61.182.20/stickers/thumb/sticker1.png",
  "isAnimated": false,
  "format": "PNG",
  "creatorId": "admin",
  "tags": ["happy", "cute"],
  "createdAt": [timestamp]
}
```


5.4. BULK IMPORT SCRIPT
-----------------------

File: scripts/bulk_import_stickers.py

Cho phÃ©p import nhiá»u packs tá»« JSON config:

Example config.json:
```json
{
  "packs": [
    {
      "name": "Cute Animals",
      "description": "Adorable animals",
      "type": "official",
      "icon": "./icons/animals.png",
      "stickers": [
        {"file": "./animals/cat1.png", "tags": ["cat", "cute"]},
        {"file": "./animals/dog1.png", "tags": ["dog", "happy"]}
      ]
    }
  ]
}
```

Usage:
```bash
python scripts/bulk_import_stickers.py --config config.json
```

================================================================================
6. USER GUIDE - Sá»¬ Dá»¤NG STICKER
================================================================================

6.1. Gá»¬I STICKER
----------------

1. Má»Ÿ chat room
2. Click nÃºt ğŸ˜Š Sticker (bÃªn cáº¡nh attach image)
3. Chá»n pack tá»« tabs (hoáº·c Recent)
4. Click sticker muá»‘n gá»­i
5. Sticker tá»± Ä‘á»™ng gá»­i trong chat

Tips:
- Swipe left/right Ä‘á»ƒ Ä‘á»•i pack
- Long-press sticker Ä‘á»ƒ preview lá»›n hÆ¡n


6.2. Táº O CUSTOM STICKER
------------------------

1. Má»Ÿ sticker picker
2. Click "â• Táº¡o sticker"
3. Chá»n áº£nh tá»« gallery
4. (Optional) Cáº¯t áº£nh thÃ nh hÃ¬nh vuÃ´ng
5. (Optional) Click "ğŸ¨ XÃ³a ná»n" Ä‘á»ƒ AI remove background
6. Click "ğŸ’¾ LÆ°u sticker"
7. Sticker Ä‘Æ°á»£c thÃªm vÃ o pack "My Stickers"

LÆ°u Ã½:
- áº¢nh nÃªn cÃ³ kÃ­ch thÆ°á»›c nhá» hÆ¡n 5MB
- Format há»— trá»£: PNG, JPEG
- AI background removal dÃ¹ng Clipdrop API (cÃ³ giá»›i háº¡n 100 requests/month)


6.3. DOWNLOAD STICKER PACK
---------------------------

1. Má»Ÿ sticker picker
2. Click "ğŸ›’ Store"
3. Browse cÃ¡c sections:
   - â­ Featured: Packs ná»•i báº­t
   - ğŸ”¥ Trending: Packs Ä‘Æ°á»£c táº£i nhiá»u nháº¥t
   - ğŸ†• New: Packs má»›i nháº¥t
4. Click "Táº£i xuá»‘ng" trÃªn pack muá»‘n cÃ³
5. Pack Ä‘Æ°á»£c thÃªm vÃ o collection cá»§a user
6. DÃ¹ng ngay trong picker


6.4. QUáº¢N LÃ STICKER Cá»¦A TÃ”I
----------------------------

1. Má»Ÿ sticker picker
2. Click "ğŸ“ My Stickers"
3. Xem táº¥t cáº£ stickers Ä‘Ã£ táº¡o
4. Click sticker Ä‘á»ƒ gá»­i
5. (Planned) Long-press Ä‘á»ƒ delete

================================================================================
7. TESTING & VERIFICATION
================================================================================

7.1. UNIT TESTS
---------------

Test StickerRepository:
- âœ“ Upload sticker to VPS
- âœ“ Create user sticker pack
- âœ“ Add sticker to pack
- âœ“ Get stickers from pack
- âœ“ Recent stickers tracking

Test BackgroundRemovalService:
- âœ“ Clipdrop API integration
- âœ“ Fallback to rembg
- âœ“ Bitmap compression
- âœ“ Error handling


7.2. INTEGRATION TESTS
----------------------

Test Sticker Sending:
1. âœ“ Pick sticker tá»« picker
2. âœ“ Send sticker message
3. âœ“ Display in chat (sent)
4. âœ“ Display in chat (received)
5. âœ“ Animated sticker playback

Test Custom Creation:
1. âœ“ Pick image from gallery
2. âœ“ Crop image
3. âœ“ Remove background
4. âœ“ Upload to VPS
5. âœ“ Save to Firestore
6. âœ“ Appear in My Stickers

Test Store:
1. âœ“ Load featured packs
2. âœ“ Load trending packs
3. âœ“ Load new packs
4. âœ“ Download pack
5. âœ“ Use downloaded pack


7.3. MANUAL TEST CASES
----------------------

[âœ“] TC01: Gá»­i sticker tá»« official pack
[âœ“] TC02: Gá»­i sticker tá»« My Stickers
[âœ“] TC03: Táº¡o sticker vá»›i background removal
[âœ“] TC04: Download pack tá»« store
[âœ“] TC05: Pin sticker message
[âœ“] TC06: Reply to sticker message
[âœ“] TC07: Forward sticker message
[âœ“] TC08: Recall sticker message
[âœ“] TC09: React to sticker message
[âœ“] TC10: View sticker in pinned message preview

================================================================================
8. KNOWN ISSUES & LIMITATIONS
================================================================================

8.1. CURRENT LIMITATIONS
------------------------

1. Clipdrop API: 100 requests/month limit
   â†’ Solution: Setup rembg on VPS as fallback

2. VPS Storage: 50GB limit
   â†’ Monitor usage, implement cleanup old stickers

3. No sticker preview in store
   â†’ Planned: Pack detail view with grid preview

4. No sticker search
   â†’ Planned: Tag-based search

5. No sticker editing after creation
   â†’ Planned: Edit/delete custom stickers


8.2. PERFORMANCE NOTES
----------------------

- Sticker images should be < 512x512 for optimal loading
- Animated stickers (WebP/GIF) may be larger files
- Use Glide caching to minimize network requests
- Recent stickers limited to 20 items


8.3. FUTURE IMPROVEMENTS
------------------------

[ ] Sticker pack preview in store
[ ] Search stickers by tag
[ ] Edit/delete custom stickers
[ ] Share sticker packs with friends
[ ] Sticker usage analytics
[ ] Premium sticker packs (paid)
[ ] Sticker pack creator tools
[ ] Animated sticker creation (GIF maker)

================================================================================
9. TROUBLESHOOTING
================================================================================

9.1. UPLOAD FAILED
------------------

Error: "Upload failed: 500"
Cause: VPS service down
Fix:
```bash
ssh root@163.61.182.20
sudo systemctl restart sticker-upload
sudo systemctl status sticker-upload
```

Error: "Upload failed: Network error"
Cause: No internet connection
Fix: Check device internet connection


9.2. BACKGROUND REMOVAL FAILED
-------------------------------

Error: "Clipdrop quota exceeded"
Cause: 100 requests/month limit reached
Fix: 
- Wait until next month
- Setup rembg on VPS
- Use without background removal


9.3. STICKER NOT LOADING
-------------------------

Error: Sticker shows placeholder icon
Cause: Invalid URL or VPS down
Fix:
1. Check VPS status
2. Verify URL in Firestore
3. Check Apache2 service


9.4. VPS SERVICES NOT STARTING
-------------------------------

Error: Service failed to start
Fix:
```bash
# Check logs
sudo journalctl -u sticker-upload -n 50
sudo journalctl -u apache2 -n 50

# Restart services
sudo systemctl restart apache2
sudo systemctl restart sticker-upload

# Check ports
sudo netstat -tlnp | grep -E '(80|3000|5000)'
```

================================================================================
10. CHANGELOG
================================================================================

[23/12/2024] - Initial Release
- âœ… Implemented sticker picker UI
- âœ… Implemented sticker message display
- âœ… Implemented custom sticker creation
- âœ… Integrated AI background removal
- âœ… Implemented sticker store
- âœ… Setup VPS infrastructure
- âœ… Configured Firestore security rules

================================================================================
11. REFERENCES
================================================================================

Documentation:
- Firebase Firestore: https://firebase.google.com/docs/firestore
- Clipdrop API: https://clipdrop.co/apis/docs/remove-background
- UCrop Library: https://github.com/Yalantis/uCrop
- Glide: https://github.com/bumptech/glide

VPS Setup:
- Apache2: https://httpd.apache.org/docs/
- Node.js Express: https://expressjs.com/
- rembg: https://github.com/danielgatis/rembg

Related Docs:
- 04_config_firestore-security-rules.txt
- 29_config_vps-sticker-server-setup.txt

================================================================================
Káº¾T THÃšC DOCUMENT
================================================================================
