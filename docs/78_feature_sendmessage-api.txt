## New sendMessage() Implementation - Using API

### OLD (Firestore Direct):
Lines 80-199 in ChatRepository.java

### NEW (API Call):

```java
/**
 * Send a message to a conversation (callback version - for backward compatibility)
 * MIGRATED: Now uses API instead of direct Firestore
 * @param conversationId ID of the conversation
 * @param message Message object to send (ID will be auto-generated by backend)
 * @param callback Callback for success/error
 */
public void sendMessage(String conversationId, Message message, SendMessageCallback callback) {
    // Create request object from Message
    SendMessageRequest request = new SendMessageRequest(message);
    
    // Call API to send message
    Call<ApiResponse<Message>> call = apiService.sendMessage(conversationId, request);
    
    call.enqueue(new Callback<ApiResponse<Message>>() {
        @Override
        public void onResponse(Call<ApiResponse<Message>> call, Response<ApiResponse<Message>> response) {
            if (response.isSuccessful() && response.body() != null) {
                ApiResponse<Message> apiResponse = response.body();
                
                if (apiResponse.isSuccess() && apiResponse.getData() != null) {
                    // Update local message with server-generated ID
                    Message savedMessage = apiResponse.getData();
                    message.setId(savedMessage.getId());
                    
                    // Backend already saved to Firestore and broadcast via WebSocket
                    // No need to update conversation lastMessage - backend does it
                    callback.onSuccess();
                } else {
                    String error = apiResponse.getMessage() != null 
                        ? apiResponse.getMessage() 
                        : "Failed to send message";
                    callback.onError(error);
                }
            } else {
                String error = "HTTP " + response.code();
                if (response.message() != null) {
                    error += ": " + response.message();
                }
                callback.onError(error);
            }
        }
        
        @Override
        public void onFailure(Call<ApiResponse<Message>> call, Throwable t) {
            String error = t.getMessage() != null 
                ? t.getMessage() 
                : "Network error";
            callback.onError(error);
        }
    });
}
```

### Key Changes:

1. **Removed Firestore direct write** - No more messageRef.set()
2. **Uses SendMessageRequest** - Converts Message to API format
3. **Backend handles everything**:
   - Generates message ID
   - Saves to Firestore
   - Updates conversation lastMessage
   - Broadcasts via WebSocket to conversation room
4. **Simpler code** - From ~130 lines to ~50 lines
5. **All message types supported** - SendMessageRequest handles them

### Backward Compatibility:

- ✅ Same method signature
- ✅ Same callback interface
- ✅ Message object updated with ID from server
- ✅ File uploads still work (upload first, then call this)

### Testing Needed:

- Text messages
- Image messages (after Cloudinary upload)
- File messages (after Cloudinary upload)  
- Reply messages
- Forward messages
- Location messages
- Sticker messages
- Contact messages (business cards)

### Rollback Plan:

Old Firestore code can be kept commented for quick rollback if needed.
