================================================================================
H∆Ø·ªöNG D·∫™N TRI·ªÇN KHAI API TRUNG GIAN (API Intermediary Deployment Guide)
================================================================================

NG√ÄY T·∫†O: 24/12/2024
M·ª§C ƒê√çCH: H∆∞·ªõng d·∫´n chi ti·∫øt deploy backend API server l√™n VPS

================================================================================
1. CHU·∫®N B·ªä VPS
================================================================================

VPS Specs ƒë√£ x√°c nh·∫≠n:
- IP: 163.61.182.20
- CPU: 2 cores
- RAM: 4GB
- OS: Ubuntu 20.04/22.04 LTS
- Subdomain: api.zolachat.site

1.1. SSH V√ÄO VPS
----------------
```bash
ssh root@163.61.182.20
```

1.2. CH·∫†Y SETUP SCRIPT
----------------------
Upload file `server/setup-vps.sh` l√™n VPS v√† ch·∫°y:

```bash
chmod +x setup-vps.sh
./setup-vps.sh
```

Script s·∫Ω t·ª± ƒë·ªông c√†i:
- Node.js 18 LTS
- Nginx
- PM2
- Redis
- Certbot (SSL)

================================================================================
2. DEPLOY API SERVER
================================================================================

2.1. CLONE CODE
---------------
```bash
cd /opt
git clone https://github.com/your-username/DoAn_ZaloClone.git zaloclone-api
cd zaloclone-api/server
```

2.2. C√ÄI DEPENDENCIES
--------------------
```bash
npm install
```

2.3. COPY FIREBASE SERVICE ACCOUNT KEY
--------------------------------------
Upload `serviceAccountKey.json` t·ª´ Firebase Console l√™n VPS:

**T·ª´ m√°y local:**
```bash
scp serviceAccountKey.json root@163.61.182.20:/opt/zaloclone-api/server/
```

**Tr√™n VPS:**
```bash
cd /opt/zaloclone-api/server
chmod 600 serviceAccountKey.json  # B·∫£o m·∫≠t file
```

2.4. T·∫†O FILE .ENV
------------------
```bash
cp .env.example .env
nano .env
```

Ch·ªânh s·ª≠a c√°c gi√° tr·ªã:
```bash
PORT=3000
NODE_ENV=production
ALLOWED_ORIGINS=https://zolachat.site,https://www.zolachat.site
FIREBASE_SERVICE_ACCOUNT_PATH=./serviceAccountKey.json
```

L∆∞u l·∫°i (Ctrl+X, Y, Enter)

2.5. TEST CH·∫†Y SERVER
---------------------
```bash
npm start
```

M·ªü tab m·ªõi SSH v√†o VPS v√† test:
```bash
curl http://localhost:3000/health
```

N·∫øu th·∫•y response {"status":"ok",...} l√† OK. D·ª´ng server (Ctrl+C).

2.6. CH·∫†Y V·ªöI PM2
-----------------
```bash
pm2 start src/index.js --name zaloclone-api
pm2 logs zaloclone-api  # Xem logs
pm2 save               # L∆∞u config
pm2 startup            # Auto start on reboot
```

Ch·∫°y command m√† PM2 print ra (th∆∞·ªùng l√† systemctl enable pm2-root)

================================================================================
3. C·∫§U H√åNH NGINX
================================================================================

3.1. COPY NGINX CONFIG
----------------------
```bash
cp /opt/zaloclone-api/server/nginx-api.conf /etc/nginx/sites-available/zaloclone-api
ln -s /etc/nginx/sites-available/zaloclone-api /etc/nginx/sites-enabled/
```

3.2. TEST NGINX CONFIG
----------------------
```bash
nginx -t
```

Ph·∫£i th·∫•y "syntax is ok" v√† "test is successful"

3.3. RELOAD NGINX
-----------------
```bash
systemctl reload nginx
```

================================================================================
4. C·∫§U H√åNH DNS
================================================================================

V√†o DNS provider (Cloudflare, etc.) v√† th√™m A record:

**Type:** A
**Name:** api
**Value:** 163.61.182.20
**TTL:** Auto

ƒê·ª£i DNS propagate (5-10 ph√∫t), test:
```bash
ping api.zolachat.site
```

================================================================================
5. C√ÄI ƒê·∫∂T SSL (HTTPS)
================================================================================

5.1. GET SSL CERTIFICATE
-------------------------
```bash
certbot --nginx -d api.zolachat.site
```

Nh·∫≠p email v√† ƒë·ªìng √Ω Terms of Service.

Certbot s·∫Ω t·ª± ƒë·ªông update Nginx config ƒë·ªÉ d√πng SSL.

5.2. TEST HTTPS
---------------
```bash
curl https://api.zolachat.site/health
```

Ph·∫£i th·∫•y response JSON.

5.3. AUTO-RENEW SSL
-------------------
Certbot ƒë√£ t·ª± ƒë·ªông setup cron job ƒë·ªÉ renew. Test:
```bash
certbot renew --dry-run
```

================================================================================
6. VERIFICATION
================================================================================

6.1. TEST API ENDPOINTS
-----------------------

**Health check:**
```bash
curl https://api.zolachat.site/health
```

**Auth verify (v·ªõi Firebase token):**
```bash
curl -H "Authorization: Bearer YOUR_FIREBASE_TOKEN" \
     https://api.zolachat.site/api/auth/verify
```

6.2. TEST WEBSOCKET
-------------------
D√πng tool nh∆∞ `wscat` ho·∫∑c test t·ª´ browser console.

6.3. MONITOR LOGS
-----------------
```bash
pm2 logs zaloclone-api
tail -f /var/log/nginx/zaloclone-api-access.log
tail -f /var/log/nginx/zaloclone-api-error.log
```

================================================================================
7. B·∫¢O M·∫¨T
================================================================================

7.1. FIREWALL
-------------
ƒê√£ setup trong script, verify:
```bash
ufw status
```

7.2. FAIL2BAN (Optional)
------------------------
C√†i Fail2Ban ƒë·ªÉ ch·ªëng brute force:
```bash
apt-get install -y fail2ban
systemctl enable fail2ban
systemctl start fail2ban
```

================================================================================
8. MONITORING & MAINTENANCE
================================================================================

8.1. KI·ªÇM TRA SERVER STATUS
---------------------------
```bash
pm2 status
pm2 monit  # Real-time monitoring
```

8.2. RESTART SERVER
-------------------
```bash
pm2 restart zaloclone-api
```

8.3. XEM RESOURCE USAGE
-----------------------
```bash
htop
```

8.4. REDIS STATUS
-----------------
```bash
redis-cli ping  # Should return PONG
```

================================================================================
9. TROUBLESHOOTING
================================================================================

9.1. Server kh√¥ng start
-----------------------
```bash
pm2 logs zaloclone-api --lines 100
```

Ki·ªÉm tra:
- serviceAccountKey.json c√≥ ƒë√∫ng path kh√¥ng
- .env c√≥ ƒë·∫ßy ƒë·ªß config kh√¥ng
- Port 3000 c√≥ conflict kh√¥ng: `netstat -tulpn | grep 3000`

9.2. Nginx 502 Bad Gateway
--------------------------
- Ki·ªÉm tra Node.js server c√≥ ch·∫°y kh√¥ng: `pm2 status`
- Ki·ªÉm tra port: `curl http://localhost:3000/health`
- Xem Nginx error log: `tail -f /var/log/nginx/error.log`

9.3. SSL certificate issue
---------------------------
```bash
certbot certificates
certbot renew --force-renewal
```

================================================================================
10. UPDATE & DEPLOY CHANGES
================================================================================

Khi c√≥ code m·ªõi:

```bash
cd /opt/zaloclone-api
git pull origin main
cd server
npm install  # N·∫øu c√≥ dependencies m·ªõi
pm2 restart zaloclone-api
```

Ho·∫∑c d√πng PM2 ecosystem file cho zero-downtime deployment.

================================================================================
11. BACKUP STRATEGY
================================================================================

11.1. Backup Firebase Service Account Key
-----------------------------------------
```bash
cp /opt/zaloclone-api/server/serviceAccountKey.json ~/backups/
```

11.2. Backup .env
-----------------
```bash
cp /opt/zaloclone-api/server/.env ~/backups/
```

================================================================================
DONE! üéâ
================================================================================

API Server should now be running at: https://api.zolachat.site

Next step: Migrate Android app to use this API (Phase 3)
