# Feature: Personal QR Code

**Date:** December 27, 2025  
**Type:** Feature  
**Priority:** Medium  
**Status:** âœ… Completed

## Overview

TÃ­nh nÄƒng táº¡o vÃ  quÃ©t mÃ£ QR trang cÃ¡ nhÃ¢n cho phÃ©p ngÆ°á»i dÃ¹ng:
- Táº¡o mÃ£ QR chá»©a liÃªn káº¿t Ä‘áº¿n trang cÃ¡ nhÃ¢n
- Chia sáº» mÃ£ QR cho báº¡n bÃ¨
- LÆ°u mÃ£ QR vÃ o thÆ° viá»‡n áº£nh
- QuÃ©t mÃ£ QR Ä‘á»ƒ xem trang cÃ¡ nhÃ¢n ngÆ°á»i khÃ¡c

---

## Features

### 1. QR Code Generation
- Táº¡o QR code vá»›i Ä‘á»‹nh dáº¡ng: `zalo://user/{userId}`
- MÃ u QR code: Primary color (#0068FF)
- KÃ­ch thÆ°á»›c: 512x512 pixels (full view), 256x256 (preview)
- Hiá»ƒn thá»‹ thÃ´ng tin user (avatar, tÃªn, bio)

### 2. QR Wallet (VÃ­ QR)
- Truy cáº­p tá»« tab "CÃ¡ nhÃ¢n" â†’ menu "VÃ­ QR"
- Xem preview mÃ£ QR cá»§a mÃ¬nh
- NÃºt "QuÃ©t mÃ£ QR" Ä‘á»ƒ má»Ÿ scanner
- NÃºt "Chia sáº»" vÃ  "LÆ°u QR"

### 3. My QR Code Activity
- Hiá»ƒn thá»‹ mÃ£ QR Ä‘áº§y Ä‘á»§ vá»›i profile card
- 3 action buttons: Chia sáº», LÆ°u áº£nh, QuÃ©t mÃ£
- Gradient background (#0068FF â†’ #00C4FF)
- Pull-to-refresh Ä‘á»ƒ táº¡o láº¡i mÃ£

### 4. QR Scanner Integration
- QuÃ©t mÃ£ `zalo://user/{userId}` â†’ má»Ÿ ProfileCardActivity
- QuÃ©t link web â†’ dialog confirm má»Ÿ browser
- QuÃ©t sá»‘ Ä‘iá»‡n thoáº¡i â†’ dialog confirm gá»i Ä‘iá»‡n
- QuÃ©t text â†’ dialog copy to clipboard

---

## QR Code Format

```
Deep Link Format: zalo://user/{firebase_user_id}

Example: zalo://user/abc123xyz789

Khi quÃ©t sáº½ má»Ÿ ProfileCardActivity vá»›i:
- EXTRA_USER_ID = "abc123xyz789"
- EXTRA_IS_EDITABLE = false
```

---

## User Flows

### Flow 1: Táº¡o vÃ  Chia sáº» QR

```
PersonalFragment 
    â†’ Click "VÃ­ QR" menu
    â†’ QrWalletFragment (xem preview QR)
    â†’ Click card QR hoáº·c nÃºt Chia sáº»
    â†’ MyQRCodeActivity (full QR)
    â†’ Click "Chia sáº»"
    â†’ Intent chooser (Messenger, Zalo, Email, etc.)
```

### Flow 2: QuÃ©t QR Ä‘á»ƒ ThÃªm Báº¡n

```
QrWalletFragment / MyQRCodeActivity
    â†’ Click "QuÃ©t mÃ£"
    â†’ QRScanActivity (camera scanner)
    â†’ QuÃ©t mÃ£ zalo://user/xxx
    â†’ Dialog confirm "Má»Ÿ trang cÃ¡ nhÃ¢n?"
    â†’ ProfileCardActivity (view profile)
    â†’ CÃ³ thá»ƒ gá»­i káº¿t báº¡n tá»« Ä‘Ã¢y
```

### Flow 3: LÆ°u QR vÃ o ThÆ° viá»‡n

```
MyQRCodeActivity
    â†’ Click "LÆ°u áº£nh"
    â†’ Request permission (Android 9-)
    â†’ Save to Pictures/ZaloQR/
    â†’ Toast "ÄÃ£ lÆ°u QR code vÃ o thÆ° viá»‡n áº£nh"
```

---

## Files Structure

### New Files Created

**Layouts:**
- `res/layout/fragment_qr_wallet.xml` - QR Wallet Fragment layout
- `res/layout/activity_my_qr_code.xml` - Full QR Code Activity layout

**Drawables:**
- `res/drawable/bg_qr_frame.xml` - QR preview frame
- `res/drawable/bg_gradient_qr.xml` - Profile card gradient
- `res/drawable/bg_avatar_circle_white.xml` - Avatar border
- `res/drawable/bg_circle_light_blue.xml` - Action button background
- `res/drawable/bg_circle_white.xml` - Logo background
- `res/drawable/ic_qr_scan.xml` - Scan QR icon
- `res/drawable/ic_download.xml` - Download icon
- `res/drawable/ic_share.xml` - Share icon
- `res/drawable/ic_refresh.xml` - Refresh icon
- `res/drawable/ic_app_logo_qr.xml` - App logo for QR center

**Menu:**
- `res/menu/menu_my_qr.xml` - MyQRCodeActivity toolbar menu

**Java:**
- `ui/qr/MyQRCodeActivity.java` - Full QR display and actions

### Modified Files

**Java:**
- `ui/personal/QrWalletFragment.java` - Complete rewrite tá»« placeholder
- `ui/personal/ProfileCardActivity.java` - Connect shareQRCode() â†’ MyQRCodeActivity

**XML:**
- `AndroidManifest.xml` - Add MyQRCodeActivity declaration
- `res/xml/file_paths.xml` - Add cache/images path for FileProvider

---

## Technical Implementation

### QR Code Generation (ZXing)

```java
private void generateQRCode() {
    String qrContent = "zalo://user/" + currentUserId;
    
    QRCodeWriter writer = new QRCodeWriter();
    int size = 512;
    BitMatrix bitMatrix = writer.encode(qrContent, BarcodeFormat.QR_CODE, size, size);

    Bitmap bitmap = Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888);
    
    int primaryColor = ContextCompat.getColor(this, R.color.primary);
    int whiteColor = ContextCompat.getColor(this, R.color.white);
    
    for (int x = 0; x < size; x++) {
        for (int y = 0; y < size; y++) {
            bitmap.setPixel(x, y, bitMatrix.get(x, y) ? primaryColor : whiteColor);
        }
    }
    
    ivQrCode.setImageBitmap(bitmap);
}
```

### QR Scanning Handler

```java
private void handleScanResult(String scannedData) {
    if (scannedData.startsWith("zalo://user/")) {
        String userId = scannedData.replace("zalo://user/", "");
        showOpenAppDialog(
            "Zalo Profile",
            "Má»Ÿ trang cÃ¡ nhÃ¢n ngÆ°á»i dÃ¹ng?",
            R.drawable.ic_avatar,
            () -> openUserProfile(userId)
        );
    }
    // ... other handlers for web links, phone numbers, etc.
}
```

### Save QR to Gallery

```java
private void saveQRToGallery() {
    String fileName = "ZaloQR_" + System.currentTimeMillis() + ".png";
    
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {
        // Android 10+ - Use MediaStore
        ContentValues values = new ContentValues();
        values.put(MediaStore.Images.Media.DISPLAY_NAME, fileName);
        values.put(MediaStore.Images.Media.MIME_TYPE, "image/png");
        values.put(MediaStore.Images.Media.RELATIVE_PATH, 
            Environment.DIRECTORY_PICTURES + "/ZaloQR");
        
        Uri uri = getContentResolver().insert(
            MediaStore.Images.Media.EXTERNAL_CONTENT_URI, values);
        OutputStream outputStream = getContentResolver().openOutputStream(uri);
        qrCodeBitmap.compress(Bitmap.CompressFormat.PNG, 100, outputStream);
    } else {
        // Android 9 and below - Direct file write
        File directory = new File(Environment.getExternalStoragePublicDirectory(
            Environment.DIRECTORY_PICTURES), "ZaloQR");
        File file = new File(directory, fileName);
        FileOutputStream outputStream = new FileOutputStream(file);
        qrCodeBitmap.compress(Bitmap.CompressFormat.PNG, 100, outputStream);
    }
}
```

### Share QR via FileProvider

```java
private void shareQRCode() {
    // Save to cache
    File cachePath = new File(getCacheDir(), "images");
    cachePath.mkdirs();
    File file = new File(cachePath, "qr_code.png");
    
    FileOutputStream stream = new FileOutputStream(file);
    qrCodeBitmap.compress(Bitmap.CompressFormat.PNG, 100, stream);
    stream.close();

    // Get URI via FileProvider
    Uri contentUri = FileProvider.getUriForFile(this,
        getPackageName() + ".fileprovider", file);

    // Share intent
    Intent shareIntent = new Intent(Intent.ACTION_SEND);
    shareIntent.setType("image/png");
    shareIntent.putExtra(Intent.EXTRA_STREAM, contentUri);
    shareIntent.putExtra(Intent.EXTRA_TEXT, 
        "QuÃ©t mÃ£ QR Ä‘á»ƒ xem trang cÃ¡ nhÃ¢n cá»§a " + userName + " trÃªn Zalo");
    shareIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
    
    startActivity(Intent.createChooser(shareIntent, "Chia sáº» QR code"));
}
```

---

## Dependencies

ÄÃ£ cÃ³ sáºµn trong `build.gradle.kts`:

```kotlin
// ZXing for QR code scanning & generation
implementation("com.journeyapps:zxing-android-embedded:4.3.0")
implementation("com.google.zxing:core:3.5.3")
```

---

## Permissions

```xml
<!-- Camera for QR scanning (already declared) -->
<uses-permission android:name="android.permission.CAMERA"/>

<!-- Storage for saving QR (Android 9 and below) -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
    android:maxSdkVersion="28" />
```

**Runtime Permission Handling:**
- Camera: Requested in QRScanActivity
- Storage (Android â‰¤9): Requested in MyQRCodeActivity before save
- Storage (Android 10+): No permission needed (Scoped Storage)

---

## UI/UX Design

### QR Wallet Fragment

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† VÃ­ QR                              â”‚ â† Toolbar
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ”² QR cá»§a tÃ´i           â†’      â”‚   â”‚
â”‚ â”‚    QuÃ©t mÃ£ Ä‘á»ƒ thÃªm báº¡n         â”‚   â”‚
â”‚ â”‚                                â”‚   â”‚
â”‚ â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚ â”‚    â”‚   QR Code    â”‚            â”‚   â”‚
â”‚ â”‚    â”‚   Preview    â”‚            â”‚   â”‚
â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚ â”‚    â—‹ Avatar  TÃªn User          â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ ğŸ“· QuÃ©t mÃ£ QR           â†’      â”‚   â”‚
â”‚ â”‚    QuÃ©t Ä‘á»ƒ thÃªm báº¡n hoáº·c má»Ÿ... â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚
â”‚ [  Chia sáº» QR  ] [   LÆ°u QR    ]    â”‚
â”‚                                      â”‚
â”‚ MÃ£ QR cá»§a báº¡n chá»©a liÃªn káº¿t Ä‘áº¿n...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### My QR Code Activity

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† QR cá»§a tÃ´i                    ğŸ”„   â”‚ â† Toolbar + Refresh
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚  â–‘â–‘â–‘â–‘â–‘ Gradient â–‘â–‘â–‘â–‘ â”‚     â”‚
â”‚         â”‚         â—‹            â”‚     â”‚ â† Avatar (80dp)
â”‚         â”‚     TÃªn User         â”‚     â”‚
â”‚         â”‚    (Optional Bio)    â”‚     â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚     â”‚
â”‚         â”‚  â”‚              â”‚    â”‚     â”‚
â”‚         â”‚  â”‚   QR Code    â”‚    â”‚     â”‚
â”‚         â”‚  â”‚   (200dp)    â”‚    â”‚     â”‚
â”‚         â”‚  â”‚              â”‚    â”‚     â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â”‚
â”‚         â”‚ QuÃ©t mÃ£ Ä‘á»ƒ xem...    â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                      â”‚
â”‚    â¬†ï¸        ğŸ“¥        ğŸ“·          â”‚
â”‚  Chia sáº»    LÆ°u áº£nh   QuÃ©t mÃ£       â”‚
â”‚                                      â”‚
â”‚ MÃ£ QR nÃ y chá»©a liÃªn káº¿t Ä‘áº¿n...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Colors & Styling

| Element | Color |
|---------|-------|
| Primary (QR dots) | `#0068FF` |
| Gradient Start | `#0068FF` |
| Gradient Center | `#0084FF` |
| Gradient End | `#00C4FF` |
| Text Primary | `#000000` |
| Text Secondary | `#757575` |
| Action Button BG | `#E8F4FD` |
| Card Background | `#FFFFFF` |

---

## Testing Checklist

### QR Generation
- [ ] QR code táº¡o Ä‘Ãºng vá»›i userId hiá»‡n táº¡i
- [ ] QR hiá»ƒn thá»‹ Ä‘Ãºng mÃ u primary
- [ ] Preview QR trong QrWalletFragment
- [ ] Full QR trong MyQRCodeActivity
- [ ] User info (name, avatar, bio) hiá»ƒn thá»‹ Ä‘Ãºng

### QR Sharing
- [ ] Chia sáº» qua Messenger
- [ ] Chia sáº» qua Zalo
- [ ] Chia sáº» qua Email
- [ ] Share text kÃ¨m theo áº£nh

### QR Saving
- [ ] LÆ°u trÃªn Android 10+ (Scoped Storage)
- [ ] LÆ°u trÃªn Android 9- (vá»›i permission request)
- [ ] áº¢nh xuáº¥t hiá»‡n trong thÆ° viá»‡n Photos
- [ ] Folder ZaloQR Ä‘Æ°á»£c táº¡o

### QR Scanning
- [ ] QuÃ©t mÃ£ zalo://user/xxx â†’ má»Ÿ ProfileCardActivity
- [ ] QuÃ©t link http/https â†’ má»Ÿ browser
- [ ] QuÃ©t sá»‘ Ä‘iá»‡n thoáº¡i â†’ má»Ÿ dialer
- [ ] QuÃ©t text khÃ¡c â†’ hiá»‡n ná»™i dung + copy

### Navigation
- [ ] PersonalFragment â†’ QrWalletFragment
- [ ] QrWalletFragment â†’ MyQRCodeActivity
- [ ] QrWalletFragment â†’ QRScanActivity
- [ ] ProfileCardActivity â†’ MyQRCodeActivity (menu)
- [ ] Back navigation tá»« táº¥t cáº£ screens

---

## Known Limitations

1. **No Logo in QR Center**
   - Logo center trong QR code hiá»‡n Ä‘ang áº©n (cÃ³ thá»ƒ implement thÃªm)
   - Cáº§n táº¡o QR vá»›i error correction level H Ä‘á»ƒ Ä‘áº·t logo

2. **Static QR**
   - QR khÃ´ng cÃ³ timestamp/expiry
   - Má»™t userId = má»™t QR vÄ©nh viá»…n

3. **Offline Limitation**
   - KhÃ´ng thá»ƒ quÃ©t QR khi offline (cáº§n má»Ÿ ProfileCardActivity vá»›i data)

---

## Future Enhancements

1. **QR vá»›i Logo**
   - Äáº·t app logo á»Ÿ giá»¯a QR code
   - Sá»­ dá»¥ng error correction level H

2. **QR Animations**
   - Hiá»‡u á»©ng scan line trong QRScanActivity
   - Fade-in animation khi QR Ä‘Æ°á»£c táº¡o

3. **QR History**
   - LÆ°u láº¡i cÃ¡c QR Ä‘Ã£ quÃ©t
   - Quick access tá»« QR Wallet

4. **Multiple QR Types**
   - QR cho group invite
   - QR cho payment (náº¿u cÃ³)
   - QR cho business card

5. **QR Customization**
   - Chá»n mÃ u QR
   - Chá»n style (dots, rounded, etc.)
   - ThÃªm frame/border decorative

---

## Related Documentation

- [26_feature_personal-tab-profile.txt](26_feature_personal-tab-profile.txt) - Personal Tab & Profile
- [VOICE_MESSAGE_INTEGRATION_GUIDE.md](../VOICE_MESSAGE_INTEGRATION_GUIDE.md) - Media sharing patterns
