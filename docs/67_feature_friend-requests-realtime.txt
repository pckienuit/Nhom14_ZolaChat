# Friend Requests Real-time Updates & UX Improvements

**NgÃ y:** 25/12/2024  
**PhiÃªn báº£n:** 1.0

---

## ğŸ“‹ Tá»•ng quan

TÃ i liá»‡u nÃ y mÃ´ táº£ cÃ¡c cáº£i tiáº¿n vá» **cáº­p nháº­t real-time** cho tÃ­nh nÄƒng lá»i má»i káº¿t báº¡n vÃ  **cáº£i thiá»‡n UX** trong á»©ng dá»¥ng ZaloClone.

### Váº¥n Ä‘á» trÆ°á»›c khi sá»­a:
1. âŒ Danh sÃ¡ch lá»i má»i khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t khi cÃ³ thay Ä‘á»•i
2. âŒ KhÃ´ng cÃ³ tÃ­nh nÄƒng thu há»“i lá»i má»i Ä‘Ã£ gá»­i
3. âŒ UI khÃ´ng pháº£n há»“i real-time khi lá»i má»i bá»‹ tá»« chá»‘i/cháº¥p nháº­n
4. âŒ Navigation khÃ´ng thuáº­n tiá»‡n (icon settings thay vÃ¬ add friend)

### Giáº£i phÃ¡p:
1. âœ… WebSocket event listeners cho táº¥t cáº£ friend request events
2. âœ… API endpoint Ä‘á»ƒ cancel/recall friend requests
3. âœ… Button state management vá»›i real-time updates
4. âœ… Cáº£i thiá»‡n navigation vá»›i icon dáº¥u cá»™ng

---

## ğŸ”§ CÃ¡c thay Ä‘á»•i chÃ­nh

### 1. **Real-time Friend Updates qua WebSocket**

#### Backend: Socket.IO Events
**File:** `server/src/routes/friends.js`

CÃ¡c event Ä‘Æ°á»£c emit:
```javascript
// Event khi cÃ³ lá»i má»i má»›i
io.to(`user:${receiverId}`).emit('friend_request_received', {
    requestId, senderId, senderName, senderEmail
});

// Event khi lá»i má»i Ä‘Æ°á»£c cháº¥p nháº­n
io.to(`user:${senderId}`).emit('friend_request_accepted', { userId });

// Event khi lá»i má»i bá»‹ tá»« chá»‘i
io.to(`user:${senderId}`).emit('friend_request_rejected', { userId });

// Event khi lá»i má»i bá»‹ thu há»“i
io.to(`user:${receiverId}`).emit('friend_request_cancelled', {
    requestId, senderId
});

// Event khi thÃªm/xÃ³a báº¡n
io.to(`user:${userId}`).emit('friend_added', { userId: friendId });
io.to(`user:${friendId}`).emit('friend_removed', { userId });
```

#### Frontend: SocketManager
**File:** `app/.../websocket/SocketManager.java`

**Thay Ä‘á»•i:**
- Äá»•i tá»« **single listener** â†’ **list of listeners** pattern
- Cho phÃ©p nhiá»u fragments láº¯ng nghe cÃ¹ng lÃºc

```java
// Interface cáº­p nháº­t
public interface OnFriendEventListener {
    void onFriendRequestReceived(String senderId, String senderName);
    void onFriendRequestAccepted(String userId);
    void onFriendRequestRejected(String userId);
    void onFriendRequestCancelled(String senderId);  // â­ Má»›i
    void onFriendAdded(String userId);
    void onFriendRemoved(String userId);
}

// Quáº£n lÃ½ listeners
private CopyOnWriteArrayList<OnFriendEventListener> friendEventListeners;

public void addFriendEventListener(OnFriendEventListener listener);
public void removeFriendEventListener(OnFriendEventListener listener);
```

#### Fragments cáº­p nháº­t:

**1. FriendRequestReceivedFragment**
```java
@Override
public void onFriendRequestCancelled(String senderId) {
    // NgÆ°á»i gá»­i thu há»“i â†’ Reload danh sÃ¡ch
    runOnUiThread(() -> {
        Toast.makeText(getContext(), "Lá»i má»i káº¿t báº¡n Ä‘Ã£ bá»‹ thu há»“i", Toast.LENGTH_SHORT).show();
        loadRequests();
    });
}
```

**2. FriendRequestSentFragment**
```java
@Override
public void onFriendRequestRejected(String userId) {
    // Bá»‹ tá»« chá»‘i â†’ Reload danh sÃ¡ch
    runOnUiThread(() -> {
        Toast.makeText(getContext(), "Lá»i má»i káº¿t báº¡n Ä‘Ã£ bá»‹ tá»« chá»‘i", Toast.LENGTH_SHORT).show();
        loadRequests();
    });
}
```

**3. ContactFragment**
```java
@Override
public void onFriendAdded(String userId) {
    // ThÃªm báº¡n â†’ Reload danh sÃ¡ch báº¡n bÃ¨
    runOnUiThread(() -> loadFriends());
}
```

---

### 2. **Thu há»“i lá»i má»i káº¿t báº¡n (Friend Request Cancellation)**

#### Backend API
**File:** `server/src/routes/friends.js`

**Endpoint má»›i:**
```javascript
DELETE /api/friends/requests/:requestId
```

**Chá»©c nÄƒng:**
- XÃ¡c thá»±c ngÆ°á»i dÃ¹ng lÃ  sender
- XÃ¡c nháº­n status = 'pending'
- XÃ³a friend request khá»i Firestore
- Emit WebSocket event `friend_request_cancelled` cho receiver

**Security:**
```javascript
// Chá»‰ sender má»›i Ä‘Æ°á»£c cancel
if (requestData.senderId !== req.user.uid) {
    return res.status(403).json({ 
        error: 'You can only cancel your own friend requests' 
    });
}

// Chá»‰ cancel Ä‘Æ°á»£c pending requests
if (requestData.status !== 'pending') {
    return res.status(400).json({ 
        error: 'Can only cancel pending requests' 
    });
}
```

#### Frontend
**Files:** 
- `FriendRepository.java` - `cancelFriendRequest(requestId)`
- `ContactViewModel.java` - Expose cancel method
- `FriendRequestSentFragment.java` - UI implementation

**Flow:**
```
User nháº¥n "Thu há»“i"
  â†“
Hiá»ƒn thá»‹ confirmation dialog
  â†“
Call ViewModel.cancelFriendRequest()
  â†“
API DELETE request
  â†“
Server emit WebSocket event
  â†“
Receiver's UI tá»± Ä‘á»™ng cáº­p nháº­t
```

---

### 3. **UX Improvements**

#### 3.1. Smart Button States
**File:** `AddFriendActivity.java`

**Button State Machine:**
```
"Káº¾T Báº N" (xanh)
    â†“ [Click]
"THU Há»’I" (Ä‘á») â† CÃ³ thá»ƒ cancel ngay
    â†“ [NgÆ°á»i kia cháº¥p nháº­n]
"ÄÃƒ LÃ€ Báº N BÃˆ" (disabled)

"THU Há»’I" (Ä‘á»)
    â†“ [NgÆ°á»i kia tá»« chá»‘i hoáº·c user nháº¥n THU Há»’I]
"Káº¾T Báº N" (xanh) â† Reset, cÃ³ thá»ƒ gá»­i láº¡i
```

**Real-time updates:**
```java
private void setupWebSocketListener() {
    friendEventListener = new SocketManager.OnFriendEventListener() {
        @Override
        public void onFriendRequestRejected(String userId) {
            if (foundUser != null && foundUser.getId().equals(userId)) {
                runOnUiThread(() -> {
                    Toast.makeText(this, "Lá»i má»i Ä‘Ã£ bá»‹ tá»« chá»‘i", Toast.LENGTH_SHORT).show();
                    resetButtonToAddFriend(); // Reset vá» "Káº¾T Báº N"
                });
            }
        }
    };
}
```

#### 3.2. Navigation Improvement
**Files:**
- `activity_friend_request.xml`
- `FriendRequestActivity.java`

**Thay Ä‘á»•i:**
- Icon âš™ï¸ (settings) â†’ â• (add)
- Click navigate â†’ `AddFriendActivity`

**Lá»£i Ã­ch UX:**
- Tá»« mÃ n "Lá»i má»i káº¿t báº¡n" â†’ Dá»… dÃ ng chuyá»ƒn sang "ThÃªm báº¡n"
- Icon trá»±c quan, rÃµ rÃ ng má»¥c Ä‘Ã­ch

---

## ğŸ“Š Flow Chart

### Friend Request Lifecycle

```
[User A] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [User B]
   â”‚                      â”‚
   â”‚  1. Gá»­i lá»i má»i     â”‚
   â”‚  (friend_request)    â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚ âœ… Cháº¥p nháº­n
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (friend_request_accepted)
   â”‚                      â”‚
   â”‚  friend_added        â”‚  friend_added
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚

HOáº¶C:
   â”‚                      â”‚
   â”‚  1. Gá»­i lá»i má»i     â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                      â”‚ âŒ Tá»« chá»‘i
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (friend_request_rejected)
   â”‚                      â”‚
   â”‚  Button reset        â”‚

HOáº¶C:
   â”‚                      â”‚
   â”‚  1. Gá»­i lá»i má»i     â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚  2. Thu há»“i          â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (friend_request_cancelled)
   â”‚                      â”‚
   â”‚                      â”‚ Request biáº¿n máº¥t
```

---

## ğŸ” Security & Validation

### Server-side Checks
```javascript
// 1. Authentication required
router.delete('/requests/:requestId', authenticateUser, ...);

// 2. Ownership verification
if (requestData.senderId !== req.user.uid) {
    return res.status(403).json({ error: 'Forbidden' });
}

// 3. Status validation
if (requestData.status !== 'pending') {
    return res.status(400).json({ error: 'Invalid status' });
}
```

### Client-side Validation
```java
// Kiá»ƒm tra requestId tá»“n táº¡i
if (currentRequestId == null) {
    Toast.makeText(this, "KhÃ´ng tÃ¬m tháº¥y lá»i má»i", Toast.LENGTH_SHORT).show();
    return;
}

// Confirmation dialog trÆ°á»›c khi cancel
new AlertDialog.Builder(getContext())
    .setTitle("Thu há»“i lá»i má»i")
    .setMessage("Báº¡n cÃ³ cháº¯c muá»‘n thu há»“i?")
    .setPositiveButton("Thu há»“i", ...)
    .setNegativeButton("Huá»·", null)
    .show();
```

---

## ğŸš€ Deployment

### 1. Deploy Server
```bash
# Upload friends.js vá»›i DELETE endpoint
scp d:\DoAn_ZaloClone\server\src\routes\friends.js root@163.61.182.20:/opt/zaloclone-api/src/routes/friends.js

# Restart server
ssh root@163.61.182.20 "pm2 restart zaloclone-api"
```

### 2. Build Android App
```bash
# Build debug APK
gradlew assembleDebug

# Build release APK
gradlew assembleRelease
```

---

## âœ… Testing Checklist

### Real-time Updates
- [ ] Gá»­i lá»i má»i â†’ Tab "ÄÃ£ nháº­n" cá»§a ngÆ°á»i kia cáº­p nháº­t ngay
- [ ] Cháº¥p nháº­n lá»i má»i â†’ Tab "ÄÃ£ gá»­i" cá»§a ngÆ°á»i gá»­i cáº­p nháº­t
- [ ] Tá»« chá»‘i lá»i má»i â†’ Tab "ÄÃ£ gá»­i" cáº­p nháº­t, button reset
- [ ] Thu há»“i lá»i má»i â†’ Tab "ÄÃ£ nháº­n" cá»§a ngÆ°á»i kia cáº­p nháº­t

### Friend Request Cancellation
- [ ] Nháº¥n "Thu há»“i" â†’ Hiá»‡n confirmation dialog
- [ ] Confirm â†’ Request bá»‹ xÃ³a khá»i cáº£ 2 bÃªn
- [ ] Receiver nháº­n toast "Lá»i má»i Ä‘Ã£ bá»‹ thu há»“i"
- [ ] Sender tháº¥y button reset vá» "Káº¾T Báº N"

### Button State Management
- [ ] "Káº¾T Báº N" â†’ Gá»­i â†’ "THU Há»’I" (mÃ u Ä‘á»)
- [ ] "THU Há»’I" â†’ Cancel â†’ "Káº¾T Báº N" (mÃ u xanh)
- [ ] Bá»‹ tá»« chá»‘i â†’ Auto reset vá» "Káº¾T Báº N"
- [ ] ÄÆ°á»£c cháº¥p nháº­n â†’ "ÄÃƒ LÃ€ Báº N BÃˆ" (disabled)

### Navigation
- [ ] Icon dáº¥u cá»™ng hiá»ƒn thá»‹ Ä‘Ãºng
- [ ] Click â†’ Navigate sang AddFriendActivity
- [ ] Back button hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng

---

## ğŸ“ Code Summary

### Files Modified

#### Server (3 files)
1. `server/src/routes/friends.js` - DELETE endpoint
2. `server/src/index.js` - Rate limiting adjusted
3. WebSocket events emitted

#### Android (10 files)
1. `websocket/SocketManager.java` - Multiple listeners pattern
2. `api/ApiService.java` - DELETE method
3. `repository/FriendRepository.java` - `cancelFriendRequest()`
4. `viewmodel/ContactViewModel.java` - Expose method
5. `ui/contact/ContactFragment.java` - Event handling
6. `ui/contact/tabs/FriendRequestSentFragment.java` - Recall UI
7. `ui/contact/tabs/FriendRequestReceivedFragment.java` - Real-time update
8. `ui/contact/AddFriendActivity.java` - Smart button states
9. `ui/contact/FriendRequestActivity.java` - Navigation
10. `MainActivity.java` - Event listener
11. `res/layout/activity_friend_request.xml` - Icon change

### Lines of Code
- **Added:** ~350 lines
- **Modified:** ~150 lines
- **Deleted:** ~50 lines

---

## ğŸ› Known Issues & Limitations

### Current Limitations
1. Button state chá»‰ lÆ°u trong memory, khÃ´ng persist qua app restart
2. Cáº§n network Ä‘á»ƒ cáº­p nháº­t real-time
3. KhÃ´ng cÃ³ offline queue cho cancel requests

### Future Improvements
1. **Persistent State:** LÆ°u request status vÃ o local database
2. **Offline Support:** Queue cancel actions khi offline
3. **Batch Operations:** Cho phÃ©p thu há»“i nhiá»u requests cÃ¹ng lÃºc
4. **Analytics:** Track cancel rate Ä‘á»ƒ cáº£i thiá»‡n UX

---

## ğŸ“š References

- [Socket.IO Documentation](https://socket.io/docs/)
- [Firebase Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Android WebSocket Best Practices](https://developer.android.com/training/basics/network-ops)
- [Material Design - Button States](https://material.io/components/buttons)

---

**TÃ¡c giáº£:** Development Team  
**Reviewer:** QA Team  
**Last Updated:** 25/12/2024 20:36
