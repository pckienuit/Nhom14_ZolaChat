# TÃ­nh NÄƒng NhÃ³m Chat - Tá»•ng Há»£p Äáº§y Äá»§

## Tá»•ng quan 4 Phases

### âœ… Phase 1: Backend & Data Models (HoÃ n thÃ nh)
- Má»Ÿ rá»™ng model Conversation há»— trá»£ nhÃ³m chat
- ThÃªm FirestoreManager.createGroupConversation()
- ThÃªm ChatRepository.createGroup()

### âœ… Phase 2: Group Creation UI (HoÃ n thÃ nh)
- CreateGroupActivity - Táº¡o nhÃ³m má»›i
- SelectableFriendsAdapter - Chá»n nhiá»u báº¡n bÃ¨
- GroupViewModel - Xá»­ lÃ½ logic táº¡o nhÃ³m
- Navigation tá»« ContactFragment

### âœ… Phase 3: Chat Interface for Groups (HoÃ n thÃ nh)
- ConversationAdapter hiá»ƒn thá»‹ icon nhÃ³m vÃ  sá»‘ thÃ nh viÃªn
- MessageAdapter hiá»ƒn thá»‹ tÃªn ngÆ°á»i gá»­i trong nhÃ³m
- RoomActivity phÃ¢n biá»‡t 1-1 chat vÃ  group chat
- Logic giá»›i háº¡n tin nháº¯n chá»‰ Ã¡p dá»¥ng cho 1-1 chat

### âœ… Phase 4: Group Management (HoÃ n thÃ nh)
- GroupInfoActivity - Xem vÃ  quáº£n lÃ½ thÃ´ng tin nhÃ³m
- ThÃªm/xÃ³a thÃ nh viÃªn (admin only)
- Äá»•i tÃªn nhÃ³m (admin only)
- Rá»i nhÃ³m / XÃ³a nhÃ³m

## Cáº¥u trÃºc file tá»•ng thá»ƒ

```
app/src/main/
â”œâ”€â”€ java/com/example/doan_zaloclone/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ Conversation.java â­ (updated)
â”‚   â”‚   â””â”€â”€ GroupMember.java â­ (new)
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ FirestoreManager.java â­ (updated)
â”‚   â”‚
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â””â”€â”€ ChatRepository.java â­ (updated)
â”‚   â”‚
â”‚   â”œâ”€â”€ viewmodel/
â”‚   â”‚   â””â”€â”€ GroupViewModel.java â­ (updated)
â”‚   â”‚
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ group/ â­ (new package)
â”‚       â”‚   â”œâ”€â”€ CreateGroupActivity.java
â”‚       â”‚   â”œâ”€â”€ SelectableFriendsAdapter.java
â”‚       â”‚   â”œâ”€â”€ GroupInfoActivity.java
â”‚       â”‚   â”œâ”€â”€ GroupMemberAdapter.java
â”‚       â”‚   â””â”€â”€ AddGroupMemberActivity.java
â”‚       â”‚
â”‚       â”œâ”€â”€ home/
â”‚       â”‚   â””â”€â”€ ConversationAdapter.java â­ (updated)
â”‚       â”‚
â”‚       â””â”€â”€ room/
â”‚           â”œâ”€â”€ RoomActivity.java â­ (updated)
â”‚           â””â”€â”€ MessageAdapter.java â­ (updated)
â”‚
â””â”€â”€ res/
    â”œâ”€â”€ layout/
    â”‚   â”œâ”€â”€ activity_create_group.xml â­
    â”‚   â”œâ”€â”€ activity_group_info.xml â­
    â”‚   â”œâ”€â”€ activity_add_group_member.xml â­
    â”‚   â”œâ”€â”€ item_selectable_friend.xml â­
    â”‚   â”œâ”€â”€ item_group_member.xml â­
    â”‚   â”œâ”€â”€ item_conversation.xml â­ (updated)
    â”‚   â”œâ”€â”€ item_message_received.xml â­ (updated)
    â”‚   â”œâ”€â”€ item_message_image_received.xml â­ (updated)
    â”‚   â””â”€â”€ dialog_edit_text.xml â­
    â”‚
    â””â”€â”€ drawable/
        â”œâ”€â”€ ic_group.xml â­
        â”œâ”€â”€ ic_camera.xml â­
        â”œâ”€â”€ ic_edit.xml â­
        â”œâ”€â”€ ic_add.xml â­
        â”œâ”€â”€ ic_close.xml â­
        â””â”€â”€ badge_background.xml â­
```

## Firestore Data Structure

### Conversation Document (Group Chat)
```json
{
  "id": "conv_123",
  "type": "GROUP",
  "name": "NhÃ³m Báº¡n ThÃ¢n",
  "adminId": "user_abc",
  "memberIds": ["user_abc", "user_def", "user_ghi"],
  "memberNames": {
    "user_abc": "Nguyá»…n VÄƒn A",
    "user_def": "Tráº§n Thá»‹ B",
    "user_ghi": "LÃª VÄƒn C"
  },
  "avatarUrl": "https://...",
  "lastMessage": "Háº¹n gáº·p lÃºc 5h nhÃ©!",
  "timestamp": 1702468800000
}
```

### Messages Subcollection
```json
{
  "id": "msg_456",
  "senderId": "user_def",
  "content": "ChÃ o má»i ngÆ°á»i!",
  "type": "TEXT",
  "timestamp": 1702468800000
}
```

## API Methods

### FirestoreManager
```java
// Phase 1
void createGroupConversation(String adminId, String groupName, 
    List<String> memberIds, OnConversationCreatedListener listener)

// Phase 4
void updateGroupName(String conversationId, String newName, 
    OnGroupUpdatedListener listener)
    
void updateGroupAvatar(String conversationId, String avatarUrl, 
    OnGroupUpdatedListener listener)
    
void addGroupMembers(String conversationId, List<String> memberIds, 
    OnGroupUpdatedListener listener)
    
void removeGroupMember(String conversationId, String memberId, 
    OnGroupUpdatedListener listener)
    
void leaveGroup(String conversationId, String userId, 
    OnGroupUpdatedListener listener)
    
void deleteGroup(String conversationId, 
    OnGroupUpdatedListener listener)
```

### ChatRepository
```java
// Phase 1
LiveData<Resource<Conversation>> createGroup(String adminId, 
    String groupName, List<String> memberIds)

// Phase 4
LiveData<Resource<Boolean>> updateGroupName(String conversationId, String newName)
LiveData<Resource<Boolean>> updateGroupAvatar(String conversationId, String avatarUrl)
LiveData<Resource<Boolean>> addGroupMembers(String conversationId, List<String> memberIds)
LiveData<Resource<Boolean>> removeGroupMember(String conversationId, String memberId)
LiveData<Resource<Boolean>> leaveGroup(String conversationId, String userId)
LiveData<Resource<Boolean>> deleteGroup(String conversationId)
```

### GroupViewModel
```java
// Phase 2
void createGroup(String adminId, String groupName, List<String> memberIds)
LiveData<Resource<Conversation>> getCreateGroupResult()

// Phase 4
void updateGroupName(String conversationId, String newName)
void updateGroupAvatar(String conversationId, String avatarUrl)
void addGroupMembers(String conversationId, List<String> memberIds)
void removeGroupMember(String conversationId, String memberId)
void leaveGroup(String conversationId, String userId)
void deleteGroup(String conversationId)
LiveData<Resource<Boolean>> getUpdateResult()
```

## User Flows

### 1. Táº¡o nhÃ³m má»›i
```
ContactFragment
    â†“ Click "Táº¡o nhÃ³m"
CreateGroupActivity
    â†“ Nháº­p tÃªn nhÃ³m
    â†“ Chá»n thÃ nh viÃªn (min 2)
    â†“ Click "Táº¡o nhÃ³m"
RoomActivity (Group Chat)
    â†“ Tá»± Ä‘á»™ng má»Ÿ phÃ²ng chat má»›i
```

### 2. Chat trong nhÃ³m
```
HomeFragment
    â†“ Click group conversation (cÃ³ icon ğŸ‘¥)
RoomActivity
    â†“ Hiá»ƒn thá»‹ tÃªn ngÆ°á»i gá»­i trÃªn má»—i tin nháº¯n
    â†“ Toolbar: "TÃªn NhÃ³m (5)"
    â†“ Gá»­i tin nháº¯n khÃ´ng giá»›i háº¡n
```

### 3. Quáº£n lÃ½ nhÃ³m
```
RoomActivity (Group)
    â†“ Click tÃªn nhÃ³m
GroupInfoActivity
    â†“ Admin: Tháº¥y Ä‘áº§y Ä‘á»§ quyá»n
    â†“ Member: Chá»‰ xem vÃ  rá»i nhÃ³m
    
Admin actions:
    - Äá»•i tÃªn nhÃ³m
    - ThÃªm thÃ nh viÃªn
    - XÃ³a thÃ nh viÃªn
    - XÃ³a nhÃ³m
    
Member actions:
    - Xem thÃ´ng tin
    - Rá»i nhÃ³m
```

## UI/UX Highlights

### Conversation List (Phase 3)
- **Group Icon**: Icon ğŸ‘¥ overlay trÃªn avatar (20dp)
- **Member Count**: Hiá»ƒn thá»‹ "(N)" bÃªn cáº¡nh tÃªn nhÃ³m
- **Group Name**: TÃªn nhÃ³m do admin Ä‘áº·t

### Chat Screen (Phase 3)
- **Toolbar**: "TÃªn NhÃ³m (N thÃ nh viÃªn)"
- **Sender Name**: TÃªn ngÆ°á»i gá»­i mÃ u primary, bold 12sp
- **Message Layout**: Text vÃ  Image Ä‘á»u cÃ³ sender name
- **Click Behavior**: Click tÃªn nhÃ³m â†’ Má»Ÿ GroupInfoActivity

### Group Info Screen (Phase 4)
- **Header**: Avatar lá»›n 100dp, tÃªn nhÃ³m, sá»‘ thÃ nh viÃªn
- **Admin Badge**: Badge "Quáº£n trá»‹ viÃªn" mÃ u primary
- **Member List**: Sáº¯p xáº¿p admin Ä‘áº§u tiÃªn
- **Action Buttons**: 
  - Rá»i nhÃ³m (mÃ u gray)
  - XÃ³a nhÃ³m (mÃ u Ä‘á», admin only)

### Create Group Screen (Phase 2)
- **Name Input**: TextInputLayout vá»›i hint "TÃªn nhÃ³m"
- **Friend List**: Checkbox multi-select
- **Counter**: "N Ä‘Ã£ chá»n" realtime update
- **Create Button**: Disabled khi tÃªn trá»‘ng hoáº·c < 2 members

## Quy táº¯c Business Logic

### Táº¡o nhÃ³m:
- âœ… TÃªn nhÃ³m khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng
- âœ… Pháº£i cÃ³ Ã­t nháº¥t 2 thÃ nh viÃªn
- âœ… Admin pháº£i náº±m trong danh sÃ¡ch thÃ nh viÃªn
- âœ… Tá»± Ä‘á»™ng táº¡o conversationId unique

### Gá»­i tin nháº¯n:
- âœ… KhÃ´ng giá»›i háº¡n tin nháº¯n trong nhÃ³m
- âœ… Giá»›i háº¡n 3 tin nháº¯n chá»‰ Ã¡p dá»¥ng cho 1-1 chat vá»›i non-friend
- âœ… Hiá»ƒn thá»‹ sender name trong group, khÃ´ng hiá»ƒn thá»‹ trong 1-1

### Quáº£n lÃ½ thÃ nh viÃªn:
- âœ… Admin cÃ³ thá»ƒ thÃªm/xÃ³a thÃ nh viÃªn
- âœ… Admin khÃ´ng thá»ƒ xÃ³a chÃ­nh mÃ¬nh
- âœ… Chá»‰ cÃ³ 1 admin trong nhÃ³m
- âœ… Member thÆ°á»ng chá»‰ cÃ³ thá»ƒ rá»i nhÃ³m

### XÃ³a nhÃ³m:
- âœ… Chá»‰ admin cÃ³ quyá»n xÃ³a
- âœ… XÃ³a conversation document â†’ Táº¥t cáº£ member khÃ´ng tháº¥y nhÃ³m
- âœ… Messages subcollection váº«n tá»“n táº¡i (cÃ³ thá»ƒ cleanup sau)

## Testing Scenarios

### Scenario 1: Táº¡o nhÃ³m thÃ nh cÃ´ng
```
Given: NgÆ°á»i dÃ¹ng Ä‘ang á»Ÿ ContactFragment
And: CÃ³ Ã­t nháº¥t 2 báº¡n bÃ¨
When: Click "Táº¡o nhÃ³m"
And: Nháº­p tÃªn "NhÃ³m Test"
And: Chá»n 2 báº¡n bÃ¨
And: Click "Táº¡o nhÃ³m"
Then: Chuyá»ƒn Ä‘áº¿n RoomActivity
And: Hiá»ƒn thá»‹ "NhÃ³m Test (3)" trÃªn toolbar
And: CÃ³ thá»ƒ gá»­i tin nháº¯n ngay láº­p tá»©c
```

### Scenario 2: Hiá»ƒn thá»‹ sender name trong group
```
Given: Äang á»Ÿ trong group chat
When: User A gá»­i tin "Hello"
Then: Tin nháº¯n hiá»ƒn thá»‹ vá»›i "Nguyá»…n VÄƒn A" á»Ÿ trÃªn
When: User B gá»­i áº£nh
Then: áº¢nh hiá»ƒn thá»‹ vá»›i "Tráº§n Thá»‹ B" á»Ÿ trÃªn
```

### Scenario 3: Admin xÃ³a thÃ nh viÃªn
```
Given: Äang á»Ÿ GroupInfoActivity vá»›i vai trÃ² admin
And: NhÃ³m cÃ³ 4 thÃ nh viÃªn
When: Click nÃºt X bÃªn cáº¡nh member C
And: XÃ¡c nháº­n "XÃ³a"
Then: Member C biáº¿n máº¥t khá»i danh sÃ¡ch
And: Sá»‘ thÃ nh viÃªn cáº­p nháº­t thÃ nh "(3)"
And: Member C khÃ´ng tháº¥y nhÃ³m trong danh sÃ¡ch ná»¯a
```

### Scenario 4: Member rá»i nhÃ³m
```
Given: Äang á»Ÿ GroupInfoActivity vá»›i vai trÃ² member
When: Click "Rá»i nhÃ³m"
And: XÃ¡c nháº­n "Rá»i nhÃ³m"
Then: Quay vá» MainActivity
And: NhÃ³m biáº¿n máº¥t khá»i danh sÃ¡ch conversations
```

### Scenario 5: PhÃ¢n biá»‡t 1-1 vÃ  Group
```
Given: Äang á»Ÿ HomeFragment
When: Click group conversation (cÃ³ icon ğŸ‘¥)
Then: RoomActivity hiá»ƒn thá»‹ sender names
And: KhÃ´ng cÃ³ giá»›i háº¡n tin nháº¯n
When: Quay láº¡i vÃ  click 1-1 conversation (khÃ´ng cÃ³ icon ğŸ‘¥)
Then: RoomActivity khÃ´ng hiá»ƒn thá»‹ sender names
And: CÃ³ giá»›i háº¡n 3 tin nháº¯n náº¿u khÃ´ng pháº£i báº¡n bÃ¨
```

## Performance Considerations

### Tá»‘i Æ°u hÃ³a Ä‘Ã£ Ã¡p dá»¥ng:
1. **DiffUtil**: Trong GroupMemberAdapter vÃ  MessageAdapter
2. **ViewHolder Pattern**: Táº¥t cáº£ RecyclerView Adapters
3. **Batch Firestore Reads**: Load members song song, cáº­p nháº­t 1 láº§n
4. **Realtime Listeners**: Chá»‰ attach khi cáº§n, remove trong onDestroy
5. **Image Loading**: Glide vá»›i placeholder, trÃ¡nh load láº¡i

### Cáº£i thiá»‡n cÃ³ thá»ƒ lÃ m:
- [ ] Pagination cho danh sÃ¡ch thÃ nh viÃªn (náº¿u nhÃ³m > 100 ngÆ°á»i)
- [ ] Cache member info trong memory
- [ ] Debounce search trong AddGroupMemberActivity
- [ ] Lazy load messages (hiá»‡n táº¡i load táº¥t cáº£)

## Security Rules (Firestore)

```javascript
// Recommended Firestore Security Rules
match /conversations/{conversationId} {
  // Allow read if user is member
  allow read: if request.auth.uid in resource.data.memberIds;
  
  // Allow create if user is in memberIds and is admin
  allow create: if request.auth.uid == request.resource.data.adminId
                && request.auth.uid in request.resource.data.memberIds;
  
  // Allow update if user is admin (for group management)
  allow update: if request.auth.uid == resource.data.adminId;
  
  // Allow delete if user is admin
  allow delete: if request.auth.uid == resource.data.adminId;
  
  match /messages/{messageId} {
    // Allow read if user is member of conversation
    allow read: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.memberIds;
    
    // Allow create if user is member
    allow create: if request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.memberIds
                  && request.auth.uid == request.resource.data.senderId;
  }
}
```

## Troubleshooting

### Lá»—i thÆ°á»ng gáº·p:

1. **"NhÃ³m pháº£i cÃ³ Ã­t nháº¥t 2 thÃ nh viÃªn"**
   - NguyÃªn nhÃ¢n: Chá»n < 2 báº¡n bÃ¨ khi táº¡o nhÃ³m
   - Giáº£i phÃ¡p: Chá»n Ã­t nháº¥t 2 ngÆ°á»i

2. **"Admin pháº£i lÃ  thÃ nh viÃªn cá»§a nhÃ³m"**
   - NguyÃªn nhÃ¢n: Bug logic, admin khÃ´ng cÃ³ trong memberIds
   - Giáº£i phÃ¡p: ÄÃ£ fix - admin tá»± Ä‘á»™ng Ä‘Æ°á»£c thÃªm vÃ o

3. **Sender name khÃ´ng hiá»ƒn thá»‹**
   - NguyÃªn nhÃ¢n: isGroupChat khÃ´ng Ä‘Æ°á»£c set
   - Giáº£i phÃ¡p: Kiá»ƒm tra RoomActivity.extractOtherUserIdAndCheckFriendship()

4. **Group icon khÃ´ng hiá»ƒn thá»‹**
   - NguyÃªn nhÃ¢n: Conversation.type khÃ´ng pháº£i "GROUP"
   - Giáº£i phÃ¡p: Kiá»ƒm tra FirestoreManager.createGroupConversation()

5. **KhÃ´ng tháº¥y nÃºt admin**
   - NguyÃªn nhÃ¢n: isAdmin check sai
   - Giáº£i phÃ¡p: Verify Conversation.isAdmin(currentUserId)

## Future Enhancements

### TÃ­nh nÄƒng má»Ÿ rá»™ng (khÃ´ng triá»ƒn khai trong 4 phases):

1. **Transfer Admin**
   - Cho phÃ©p admin chá»‰ Ä‘á»‹nh admin má»›i trÆ°á»›c khi rá»i nhÃ³m
   - UI: Dialog chá»n member

2. **Group Notifications**
   - Push notification khi Ä‘Æ°á»£c thÃªm vÃ o nhÃ³m
   - Push notification khi bá»‹ xÃ³a khá»i nhÃ³m
   - Push notification khi cÃ³ tin nháº¯n má»›i

3. **Group Avatar Upload**
   - UI Ä‘Ã£ sáºµn sÃ ng
   - Cáº§n implement image picker + Firebase Storage upload

4. **Group Settings**
   - Cho phÃ©p member send messages hay chá»‰ admin
   - Ai cÃ³ thá»ƒ add members (chá»‰ admin hay má»i ngÆ°á»i)
   - Group description

5. **Member Roles**
   - ThÃªm role "Moderator" giá»¯a Admin vÃ  Member
   - Moderator cÃ³ thá»ƒ xÃ³a tin nháº¯n, kick member

6. **Search Messages**
   - TÃ¬m kiáº¿m tin nháº¯n trong group
   - Filter by sender, date, type

7. **Pin Messages**
   - Admin/Moderator pin tin nháº¯n quan trá»ng
   - Hiá»ƒn thá»‹ pinned messages á»Ÿ Ä‘áº§u chat

8. **Group Analytics**
   - Sá»‘ tin nháº¯n gá»­i/nháº­n
   - Active members
   - Storage usage

## Káº¿t luáº­n

TÃ­nh nÄƒng Group Chat Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai hoÃ n chá»‰nh qua 4 phases:
- âœ… **Backend infrastructure** sáºµn sÃ ng
- âœ… **UI/UX** Ä‘áº§y Ä‘á»§ vÃ  trá»±c quan
- âœ… **Permission system** rÃµ rÃ ng (Admin vs Member)
- âœ… **Integration** vá»›i toÃ n bá»™ app
- âœ… **Testing** cÃ³ thá»ƒ báº¯t Ä‘áº§u ngay

**Tá»•ng sá»‘ files má»›i/updated**: 25+ files
**Tá»•ng sá»‘ methods má»›i**: 15+ methods
**Thá»i gian triá»ƒn khai**: 4 phases (Phase 1-4)
**Test coverage**: 5 main scenarios documented

á»¨ng dá»¥ng Zola Chat Ä‘Ã£ cÃ³ Ä‘áº§y Ä‘á»§ chá»©c nÄƒng Group Chat chuyÃªn nghiá»‡p! ğŸ‰
